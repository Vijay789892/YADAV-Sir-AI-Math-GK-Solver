

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math & GK Solver</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden;
    }

    .container {
        width: 100%;
        max-width: 450px;
        height: 100vh; /* Full height on mobile */
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        overflow: hidden; /* Prevent container scroll, main/outputArea manage it */
    }

    header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.1em;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    header .menu-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.5em;
        cursor: pointer;
        padding: 8px;
        border-radius: 10%;
        transition: all 0.3s ease;
    }

    header .menu-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    header .app-title {
        font-weight: 600;
        font-size: 1.3em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        position: relative;
    }

    textarea#questionInput {
        flex-grow: 0;
        width: calc(100% - 30px);
        min-height: 120px;
        border: 2px solid transparent;
        border-radius: 15px;
        padding: 20px;
        font-size: 1.1em;
        resize: none;
        outline: none;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    textarea#questionInput:focus {
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .input-options {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
    }

    .action-buttons button, .file-input-wrapper {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        width: 55px;
        height: 55px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.4em;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .action-buttons button:hover, .file-input-wrapper:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
    }

    .action-buttons button:disabled, .file-input-wrapper.disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    #imagePreview {
        max-width: 100%;
        max-height: 120px;
        margin: 10px 0;
        border-radius: 10px;
        display: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        object-fit: contain;
    }

    #outputArea {
        flex-grow: 1;
        flex-shrink: 1;
        flex-basis: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        font-size: 1.1em;
        word-wrap: break-word;
        overflow-y: auto;
        margin-top: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        min-height: 150px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    #outputTextContent {
        flex-grow: 1;
        overflow-y: auto;
        padding-bottom: 50px;
        /* Dynamic font size will be applied here */
        font-size: var(--output-font-size, 1.1em); 
    }
    
    #outputPlaceholder {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 1.2em;
        font-weight: 500;
        opacity: 0.9;
    }

    /* Main Speaker Button Styles */
    #speakerBtn, #favoriteOutputBtn { /* Added #favoriteOutputBtn */
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: none; /* Controlled by JS */
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        color: white;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        z-index: 5;
    }

    #speakerBtn:hover, #favoriteOutputBtn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 15px rgba(26, 188, 156, 0.4);
    }

    #speakerBtn.playing {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
    }

    #favoriteOutputBtn {
        right: 70px; /* Position next to speaker button */
        background: linear-gradient(135deg, #f06292 0%, #e91e63 100%); /* Pink/Red for favorite */
    }
    #favoriteOutputBtn.favorited {
        background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%); /* Gold/Orange when favorited */
    }

    /* History & Favorites List Speaker Button Styles */
    .history-speaker-btn {
        background: rgba(102, 126, 234, 0.2);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: none; /* Controlled by JS based on TTS support */
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
        color: #667eea;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        margin-left: 10px;
        vertical-align: middle;
        flex-shrink: 0;
    }

    .history-speaker-btn:hover {
        background: rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .history-speaker-btn.playing {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        color: white;
    }

    /* PDF Download Button Style */
    #downloadHistoryPdfBtn {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); /* Orange for PDF */
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px 20px;
        font-size: 1em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 20px auto 0; /* Center it below history list */
        box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        transition: all 0.3s ease;
        width: calc(100% - 40px); /* Adjust width */
        max-width: 250px;
    }

    #downloadHistoryPdfBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);
    }
    #downloadHistoryPdfBtn:disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Individual PDF download button in history list / favorites list */
    .single-pdf-btn {
        background: rgba(243, 156, 18, 0.2); /* Lighter orange */
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
        color: #f39c12;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        margin-left: 10px;
        vertical-align: middle;
        flex-shrink: 0;
    }

    .single-pdf-btn:hover {
        background: rgba(243, 156, 18, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }


    .send-btn {
        position: absolute;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.6em;
        color: white;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        transition: all 0.3s ease;
        z-index: 10;
    }

    .send-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6);
    }

    .send-btn:disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Camera Modal Styles */
    .camera-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .camera-modal.show {
        visibility: visible;
        opacity: 1;
    }

    .camera-container {
        position: relative;
        max-width: 90%;
        max-height: 70%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        overflow: hidden;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    #cameraVideo {
        width: 100%;
        height: auto;
        border-radius: 18px;
        display: block;
    }

    .camera-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .camera-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .camera-btn:hover {
        transform: scale(1.1);
        background: white;
    }

    .capture-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        width: 70px;
        height: 70px;
        font-size: 1.8em;
    }

    .capture-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
    }

    .close-camera-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-camera-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    /* Common Modal Styles */
    .history-modal, .main-menu-modal, .settings-modal, .favorites-modal { /* Added .favorites-modal */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .history-modal.show, .main-menu-modal.show, .settings-modal.show, .favorites-modal.show { /* Added .favorites-modal */
        visibility: visible;
        opacity: 1;
    }

    .modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-content h2 {
        margin-top: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.5em;
    }

    .modal-content .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 107, 107, 0.1);
        border: none;
        font-size: 1.5em;
        color: #ff6b6b;
        cursor: pointer;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-content .close-btn:hover {
        background: rgba(255, 107, 107, 0.2);
        transform: scale(1.1);
    }

    #historyList, #mainMenuOptions, #favoritesList { /* Added #favoritesList */
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #historyList li, #favoritesList li { /* Added #favoritesList li */
        background: rgba(102, 126, 234, 0.1);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 15px;
        font-size: 0.95em;
        line-height: 1.5;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    #historyList li:hover, #favoritesList li:hover { /* Added #favoritesList li */
        background: rgba(102, 126, 234, 0.15);
        transform: translateX(5px);
    }

    #historyList li strong, #favoritesList li strong { /* Added #favoritesList li */
        color: #667eea;
    }

    #historyList li .answer-content, #favoritesList li .answer-content { /* Added #favoritesList li */
        display: flex;
        align-items: center;
        margin-top: 8px;
        color: #555;
        word-break: break-word;
    }

    #historyList li .answer-text-wrapper, #favoritesList li .answer-text-wrapper { /* Added #favoritesList li */
        flex-grow: 1;
    }

    #historyList li small, #favoritesList li small { /* Added #favoritesList li */
        display: block;
        margin-top: 8px;
        color: #999;
        font-size: 0.8em;
    }

    /* Main Menu Specific Styles */
    #mainMenuOptions li {
        margin-bottom: 10px;
    }

    #mainMenuOptions button, .settings-option button { /* Added settings-option button */
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        font-size: 1.1em;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    #mainMenuOptions button:hover, .settings-option button:hover { /* Added settings-option button */
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
    }

    #mainMenuOptions button i, .settings-option i { /* Added settings-option i */
        font-size: 1.3em;
        color: #764ba2;
    }

    .menu-divider {
        height: 1px;
        background-color: rgba(0,0,0,0.1);
        margin: 20px 0;
    }

    /* Settings Modal Specific Styles */
    .settings-option {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 10px;
        background: rgba(102, 126, 234, 0.05);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .settings-option label {
        display: block;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    .settings-option select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 1em;
        background-color: white;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .settings-option select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        outline: none;
    }

    .settings-option .text-size-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .settings-option .text-size-options label {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        color: #667eea;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: normal;
        margin-bottom: 0; /* Override default label margin */
        flex-grow: 1;
        text-align: center;
        min-width: 40px; /* Ensure buttons don't get too small */
    }

    .settings-option .text-size-options input[type="radio"] {
        display: none;
    }

    .settings-option .text-size-options input[type="radio"]:checked + label {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #764ba2;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .settings-option .text-size-options label:hover {
        background: rgba(102, 126, 234, 0.2);
    }

    #removeAdsBtn {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%); /* Green for 'No Ads' */
        color: white;
        margin-top: 15px;
        font-size: 1.1em;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    #removeAdsBtn:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
    }
    #removeAdsBtn:disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }


    /* Loading animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Ad Banner Styles */
    .ad-banner {
        width: 100%;
        padding: 10px; /* Some padding around the ad */
        box-sizing: border-box; /* Include padding in width */
        text-align: center; /* Center the ad if it's smaller than 100% */
        background: rgba(0, 0, 0, 0.05); /* Slight background to separate it */
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        margin-top: auto; /* Push it to the bottom if container is flex-column */
        min-height: 120px; /* Give it enough space for the ad (100px + padding) */
        display: flex; /* Use flex to center iframe if it's smaller */
        justify-content: center;
        align-items: center;
        overflow: hidden; /* Prevent overflow if ad content is too big */
    }

    /* Responsive design */
    @media (max-width: 480px) {
        .container {
            border-radius: 0;
            height: 100vh;
        }
        
        main {
            padding: 15px;
        }
        
        .send-btn {
            bottom: 100px;
            right: 20px;
        }

        #speakerBtn {
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            font-size: 1.1em;
        }
        #favoriteOutputBtn { /* Position for mobile */
            bottom: 10px;
            right: 60px; /* Adjust based on speakerBtn size */
            width: 40px;
            height: 40px;
            font-size: 1.1em;
        }


        .history-speaker-btn, .single-pdf-btn { /* Apply to both new buttons */
            width: 28px;
            height: 28px;
            font-size: 0.7em;
            margin-left: 8px;
        }

        #downloadHistoryPdfBtn {
            padding: 10px 15px;
            font-size: 0.9em;
            gap: 8px;
        }

        .camera-container {
            max-width: 95%;
            max-height: 60%;
        }

        .camera-controls {
            bottom: 10px;
            gap: 15px;
        }

        .camera-btn {
            width: 50px;
            height: 50px;
            font-size: 1.3em;
        }

        .capture-btn {
            width: 60px;
            height: 60px;
            font-size: 1.6em;
        }

        .modal-content {
            max-width: 95%;
            padding: 20px;
        }

        .ad-banner {
            padding: 8px;
            min-height: 100px; /* Slightly less height on mobile */
        }
    }


 .social-buttons {
            position: fixed;
            top: 25%;
            right: 4px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
        }
        
        .social-btn {
            width: 25px;
            height: 25px;
            border-radius: 5%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .social-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        

        
        .social-icon {
            color: white;
            font-size: 22px;
        }


</style>
</head>
<body>

  <div class="social-buttons">
        
        <!-- WhatsApp -->
        <a href="https://whatsapp.com/channel/0029VbAUHnn7NoZz3vfqy43Z" class="social-btn whatsapp-btn" target="_blank">
            <i class="fab fa-whatsapp"></i>
        </a>


        <!-- Website -->
        <a href="https://yadavsirai.blogspot.com/?m=1" class="social-btn website-btn" target="_blank">
            <i class="fas fa-globe"></i>
        </a>

        <!-- Game -->
        <a href="https://yadav-sir-learn-english-app.vercel.app/#" class="social-btn game-btn" target="_blank">
            <i class="fas fa-gamepad"></i>
        </a>
 </div>






    <div class="container">
        <header>
            <button class="menu-btn" id="menuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="app-title">YADAV Sir AI  </div> Math & GK Solver
        </header>
        <main>
            <textarea id="questionInput" placeholder="‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç! ‡§î‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ¬∞ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§Ø‡•á!     "></textarea>
          
            
            <div class="input-options">
                <div class="action-buttons">
                    <button id="micBtn" title="‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡•ã‡§≤‡•á‡§Ç">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="cameraBtn" title="‡§õ‡§µ‡§ø ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button id="clearInputBtn" title="‡§á‡§®‡§™‡•Å‡§ü ‡§î‡§∞ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button id="shareResultBtn" title="‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§î‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>

                <div class="file-input-wrapper">
                    <input type="file" id="imageInput" accept="image/*" title="‡§™‡•Ç‡§õ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">
                    <i class="fas fa-image"></i>
                </div>
            </div>
            
            <img id="imagePreview" alt="Image Preview">


               <div id="outputArea">
                <div id="outputTextContent">
                    <div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§   ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á ‡§ö‡•Å‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‚ò∞ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§Ø‡•á ! ‚ú®</div>
                </div>

             <button id="speakerBtn" title="‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç">
                    <i class="fas fa-volume-up"></i>
                </button>
                <!-- New Favorite Button in Output Area -->
                <button id="favoriteOutputBtn" title="‡§â‡§§‡•ç‡§§‡§∞ ‡§ï‡•ã ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            
            <button class="send-btn" id="sendBtn" title="‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç">
                <i class="fas fa-paper-plane">¬∞</i>
            </button>
        </main>

<script type="text/javascript">
    atOptions = {
        'key' : '68baa3fdb766c51c4e785d08e5b8a541',
        'format' : 'iframe',
        'height' : 60,
        'width' : 468,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/68baa3fdb766c51c4e785d08e5b8a541/invoke.js"></script>






 <!-- End Ad Banner container -->

        <!-- Camera Modal -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <button class="close-camera-btn" id="closeCameraBtn">
                    <i class="fas fa-times"></i>
                </button>
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-btn" id="switchCameraBtn" title="‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="camera-btn capture-btn" id="captureBtn" title="‡§´‡•ã‡§ü‡•ã ‡§ñ‡•Ä‡§Ç‡§ö‡§ø‡§è">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="camera-btn" id="flashBtn" title="‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡•á‡§Ç">
                        <i class="fas fa-bolt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Menu Modal -->
        <div class="main-menu-modal" id="mainMenuModal">
            <div class="modal-content">
                <button class="close-btn" id="closeMainMenuBtn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>üöÄ ‡§Æ‡•á‡§®‡•Ç</h2>





  <script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>

                <ul id="mainMenuOptions">

                     <li><button id="settingsBtn"><i class="fas fa-gear"></i> ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ( ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á ) </button></li>
      
                    <!-- New Favorites Button -->
                    <li><button id="openHistoryBtn"><i class="fas fa-history"></i> ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§î‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°  </button></li>
                    <li><button id="openFavoritesBtn"><i class="fas fa-heart"></i> ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ PDF </button></li>

           
                 
                    <li><button id="newGkQuestionBtn"><i class="fas fa-brain"></i> ‡§®‡§Ø‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§®</button></li>
                    <li><button id="newMathProblemBtn"><i class="fas fa-calculator"></i> ‡§®‡§à ‡§ó‡§£‡§ø‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ</button></li>


                     <li><a href="https://median.co/share/nokjya#apk" target="_blank"><button id="downloadAppBtn"><i class="fas fa-download"></i> ‡§ê‡§™ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (PWA)</button></a></li>






                    <li><button class="cta-button" id="cta-menu-btn" onclick="window.open('https://yadavsir.vercel.app/', '_blank')">üìù YADAV Sir AI ‡§∏‡•á Doubt clear ‡§ï‡§∞‡•á</button></li>
            

                    <li class="menu-divider"></li>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



                    <li class="menu-divider"></li>

   
                    <li>
                        <a href="https://yadav-sir-learn-english-app.vercel.app/#" id="learnEnglishBtn" style="display: inline-block; padding: 10px 20px; background-color: #007BFF; color: white; border-radius: 5px; text-decoration: none;">
                            <i class="fas fa-book"></i> ‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂ ‡§¨‡•ã‡§≤‡§®‡§æ ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§Æ‡§æ‡§§‡•ç‡§∞ 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç  ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á </a>
                    </li>
                     <li><button id="rateAppBtn"><i class="fas fa-thumbs-up"></i> ‡§á‡§∏ ‡§ê‡§™ ‡§ï‡•ã ‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button></li>
                              
                    <li><button id="privacyPolicyBtn"><i class="fas fa-shield-alt"></i> ‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§®‡•Ä‡§§‡§ø</button></li>
                    <li><button id="shareAppBtn"><i class="fas fa-share-alt"></i> ‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</button></li>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


<script async="async" data-cfasync="false" src="//pl26909564.profitableratecpm.com/6ebb90926991ce60974cf8782c909bec/invoke.js"></script>
<div id="container-6ebb90926991ce60974cf8782c909bec"></div>


<script type='text/javascript' src='//pl26909800.profitableratecpm.com/26/e9/1e/26e91e385714762f7162473ebb055f5f.js'></script>



<script type="text/javascript">
    atOptions = {
        'key' : 'fc25a66bbc733547fe693d84367c513e',
        'format' : 'iframe',
        'height' : 250,
        'width' : 300,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/fc25a66bbc733547fe693d84367c513e/invoke.js"></script>






<script type="text/javascript">
    atOptions = {
        'key' : 'fc25a66bbc733547fe693d84367c513e',
        'format' : 'iframe',
        'height' : 250,
        'width' : 300,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/fc25a66bbc733547fe693d84367c513e/invoke.js"></script>








<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>
                 

<script type="text/javascript">
    atOptions = {
        'key' : 'fc25a66bbc733547fe693d84367c513e',
        'format' : 'iframe',
        'height' : 250,
        'width' : 300,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/fc25a66bbc733547fe693d84367c513e/invoke.js"></script>







<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


<script type="text/javascript">
    atOptions = {
        'key' : 'fc25a66bbc733547fe693d84367c513e',
        'format' : 'iframe',
        'height' : 250,
        'width' : 300,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/fc25a66bbc733547fe693d84367c513e/invoke.js"></script>


   </div>
                </ul>
            </div>
        </div>

        <!-- Favorites Modal (New Feature) -->
        <div class="favorites-modal" id="favoritesModal">
            <div class="modal-content">
                <button class="close-btn" id="closeFavoritesBtn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>‚ù§Ô∏è ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ</h2>



   <script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



                <ul id="favoritesList">
                    <!-- Favorites items will be inserted here by JavaScript -->
                </ul>
            </div>
        </div>

        <!-- History Modal -->
        <div class="history-modal" id="historyModal">
            <div class="modal-content">
                <button class="close-btn" id="closeHistoryBtn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>üìö ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h2>


<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>




<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



                <button id="downloadHistoryPdfBtn" title="‡§™‡•Ç‡§∞‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">
                    <i class="fas fa-file-pdf"></i> ‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                </button>

                <ul id="historyList">
                    <!-- History items will be inserted here by JavaScript -->
                </ul>         
            </div>     
        </div>

        <!-- Settings Modal -->
        <div class="settings-modal" id="settingsModal">
            <div class="modal-content">
                <button class="close-btn" id="closeSettingsBtn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>




<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


                
                <div class="settings-option">
                    <label for="languageSelect">‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:</label>
                    <select id="languageSelect">
                        <option value="auto">‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ (Auto-detect)</option>
                        <option value="hi">üáÆüá≥‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                        <option value="en">üá∫üá∏‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä (English)</option>
                <option value="es">üá™üá∏ ‡§∏‡•ç‡§™‡•á‡§®‡§ø‡§∂ (Spanish)</option>
                <option value="fr">üá´üá∑ ‡§´‡•ç‡§∞‡•á‡§Ç‡§ö (French)</option>
                <option value="de">üá©üá™ ‡§ú‡§∞‡•ç‡§Æ‡§® (German)</option>
                <option value="ja">üáØüáµ ‡§ú‡§æ‡§™‡§æ‡§®‡•Ä (Japanese)</option>
                <option value="ko">üá∞üá∑ ‡§ï‡•ã‡§∞‡§ø‡§Ø‡§æ‡§à (Korean)</option>
                <option value="zh">üá®üá≥ ‡§ö‡•Ä‡§®‡•Ä (Chinese)</option>
                <option value="ar">üá∏üá¶ ‡§Ö‡§∞‡§¨‡•Ä (Arabic)</option>
                <option value="ru">üá∑üá∫ ‡§∞‡•Ç‡§∏‡•Ä (Russian)</option>
                <option value="pt">üáßüá∑ ‡§™‡•Å‡§∞‡•ç‡§§‡§ó‡§æ‡§≤‡•Ä (Portuguese)</option>
                <option value="it">üáÆüáπ ‡§á‡§§‡§æ‡§≤‡§µ‡•Ä (Italian)</option>
                <option value="nl">üá≥üá± ‡§°‡§ö (Dutch)</option>
                <option value="sv">üá∏üá™ ‡§∏‡•ç‡§µ‡•Ä‡§°‡§ø‡§∂ (Swedish)</option>
                <option value="da">üá©üá∞ ‡§°‡•á‡§®‡§ø‡§∂ (Danish)</option>
                <option value="no">üá≥üá¥ ‡§®‡•â‡§∞‡•ç‡§µ‡•á‡§ú‡§ø‡§Ø‡§® (Norwegian)</option>
                <option value="fi">üá´üáÆ ‡§´‡§ø‡§®‡§ø‡§∂ (Finnish)</option>
                <option value="pl">üáµüá± ‡§™‡•ã‡§≤‡§ø‡§∂ (Polish)</option>
                <option value="tr">üáπüá∑ ‡§§‡•Å‡§∞‡•ç‡§ï‡•Ä (Turkish)</option>
                <option value="th">üáπüá≠ ‡§•‡§æ‡§à (Thai)</option>
                <option value="vi">üáªüá≥ ‡§µ‡§ø‡§Ø‡§§‡§®‡§æ‡§Æ‡•Ä (Vietnamese)</option>
                <option value="id">üáÆüá© ‡§á‡§Ç‡§°‡•ã‡§®‡•á‡§∂‡§ø‡§Ø‡§æ‡§à (Indonesian)</option>
                <option value="ms">üá≤üáæ ‡§Æ‡§≤‡§Ø (Malay)</option>
                <option value="tl">üáµüá≠ ‡§´‡§ø‡§≤‡§ø‡§™‡§ø‡§®‡•ã (Filipino)</option>
                <option value="bn">üáßüá© ‡§¨‡§Ç‡§ó‡§æ‡§≤‡•Ä (Bengali)</option>
                <option value="ur">üáµüá∞ ‡§â‡§∞‡•ç‡§¶‡•Ç (Urdu)</option>
                <option value="ta">üáÆüá≥ ‡§§‡§Æ‡§ø‡§≤ (Tamil)</option>
                <option value="te">üáÆüá≥ ‡§§‡•á‡§≤‡•Å‡§ó‡•Å (Telugu)</option>
                <option value="mr">üáÆüá≥ ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                <option value="gu">üáÆüá≥ ‡§ó‡•Å‡§ú‡§∞‡§æ‡§§‡•Ä (Gujarati)</option>
                <option value="kn">üáÆüá≥ ‡§ï‡§®‡•ç‡§®‡§°‡§º (Kannada)</option>
                <option value="ml">üáÆüá≥ ‡§Æ‡§≤‡§Ø‡§æ‡§≤‡§Æ (Malayalam)</option>
                <option value="pa">üáÆüá≥ ‡§™‡§Ç‡§ú‡§æ‡§¨‡•Ä (Punjabi)</option>
                <option value="or">üáÆüá≥ ‡§ì‡§°‡§º‡§ø‡§Ø‡§æ (Odia)</option>
                <option value="as">üáÆüá≥ ‡§Ö‡§∏‡§Æ‡§ø‡§Ø‡§æ (Assamese)</option>
                    </select>
                </div>

                <div class="settings-option">
                    <label>‡§â‡§§‡•ç‡§§‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§Ü‡§ï‡§æ‡§∞:</label>
                    <div class="text-size-options" id="textSizeOptions">
                        <input type="radio" id="textSizeSmall" name="textSize" value="14px">
                        <label for="textSizeSmall">‡§õ‡•ã‡§ü‡§æ</label>
                        <input type="radio" id="textSizeMedium" name="textSize" value="16px" checked>
                        <label for="textSizeMedium">‡§Æ‡§ß‡•ç‡§Ø‡§Æ</label>
                        <input type="radio" id="textSizeLarge" name="textSize" value="18px">
                        <label for="textSizeLarge">‡§¨‡§°‡§º‡§æ</label>
                    </div>
                </div>
             



                 
            
                


                <div class="settings-option">


                <li><button class="cta-button" id="cta-menu-btn" onclick="window.open('https://yadav-sirapp.vercel.app/', '_blank')"> üí∞ YADAV Sir ‡§ï‡•ã App ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡§æ‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à  Thanks for you ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á   </button></li>


</div>


<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


  <script type="text/javascript">
    atOptions = {
        'key' : 'fc25a66bbc733547fe693d84367c513e',
        'format' : 'iframe',
        'height' : 250,
        'width' : 300,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/fc25a66bbc733547fe693d84367c513e/invoke.js"></script>
                
<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>


<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>

<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



<script type="text/javascript">
    atOptions = {
        'key' : 'dfb9f45a0bfc2772a4f0f47ce1391707',
        'format' : 'iframe',
        'height' : 50,
        'width' : 320,
        'params' : {}
    };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/dfb9f45a0bfc2772a4f0f47ce1391707/invoke.js"></script>



                    <button id="removeAdsBtn"><i class="fas fa-ban"></i> ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç </button>
                </div>

            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Get DOM elements
        const questionInput = document.getElementById('questionInput');
        const outputArea = document.getElementById('outputArea');
        const outputTextContent = document.getElementById('outputTextContent');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const micBtn = document.getElementById('micBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const clearInputBtn = document.getElementById('clearInputBtn');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const sendBtn = document.getElementById('sendBtn');
        const menuBtn = document.getElementById('menuBtn');
        
        // History elements
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const downloadHistoryPdfBtn = document.getElementById('downloadHistoryPdfBtn'); 

        // Main Menu elements
        const mainMenuModal = document.getElementById('mainMenuModal');
        const closeMainMenuBtn = document.getElementById('closeMainMenuBtn');
        const openHistoryBtn = document.getElementById('openHistoryBtn');
        const downloadAppBtn = document.getElementById('downloadAppBtn');
        const shareAppBtn = document.getElementById('shareAppBtn');
        const newGkQuestionBtn = document.getElementById('newGkQuestionBtn');
        const newMathProblemBtn = document.getElementById('newMathProblemBtn');
        
        // New Menu Options
        const rateAppBtn = document.getElementById('rateAppBtn');
        const privacyPolicyBtn = document.getElementById('privacyPolicyBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const learnEnglishBtn = document.getElementById('learnEnglishBtn');

        // Settings Modal elements
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const languageSelect = document.getElementById('languageSelect');
        const textSizeOptions = document.getElementById('textSizeOptions'); // Now correctly referencing the div
        const removeAdsBtn = document.getElementById('removeAdsBtn');
        const adContainer = document.getElementById('adContainer'); // Main ad container
        const allAdDivs = document.querySelectorAll('.ad-banner'); // All ad containers (main + menu/history modals)

        // Camera elements
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const flashBtn = document.getElementById('flashBtn');

        // Share Result Button
        const shareResultBtn = document.getElementById('shareResultBtn');

        // Speaker Button and Speech Synthesis (for main output)
        const speakerBtn = document.getElementById('speakerBtn');
        let currentUtterance = null;
        let isSpeaking = false;
        let selectedTTSVoice = null; 

        // Favorites elements
        const favoritesModal = document.getElementById('favoritesModal');
        const favoritesList = document.getElementById('favoritesList');
        const closeFavoritesBtn = document.getElementById('closeFavoritesBtn');
        const openFavoritesBtn = document.getElementById('openFavoritesBtn'); // The button in the main menu
        const favoriteOutputBtn = document.getElementById('favoriteOutputBtn'); // New: Button in output area

        // API Configuration
        const GEMINI_API_KEY = 'AIzaSyDHy9J04dI8LdK1ijNJMrRXubJ5ucx9rdk'; // Keep your API key private in a real app

        // Variables for image data, history, and camera
        let uploadedImageData = null;
        let history = []; // This will be loaded from localStorage
        let favorites = []; // New array for favorites

        // Store the last answered question and answer for easy favoriting
        let lastAnsweredQuestion = null;
        let lastAnsweredText = null;
        let lastAnsweredImageUsed = false;


        // Settings variables with defaults
        let appSettings = {
            language: 'auto', // 'auto', 'hi', 'en'
            textSize: '16px', // '12px', '16px', '20px', etc.
            isAdFree: false // boolean
        };
        
        let currentStream = null;
        let currentFacingMode = 'environment';
        let flashEnabled = false;

        const APP_NAME = "YADAV Sir AI Math & GK Solver";
        const APP_URL = window.location.href; // Get current URL for linking

        // Speech Recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.interimResults = false;
            recognition.lang = 'hi-IN'; // Default language for speech input
            recognition.continuous = false;
        } else {
            micBtn.disabled = true;
            micBtn.title = "‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à";
        }

        // --- Settings Management Functions ---
        const saveSettings = () => {
            try {
                localStorage.setItem('aiSolverSettings', JSON.stringify(appSettings));
                console.log('‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à‡§Ç‡•§');
            } catch (e) {
                console.error('‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ï‡•ã localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
            }
        };

        const loadSettings = () => {
            try {
                const storedSettings = localStorage.getItem('aiSolverSettings');
                if (storedSettings) {
                    appSettings = { ...appSettings, ...JSON.parse(storedSettings) };
                    console.log('‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§ó‡§à‡§Ç:', appSettings);
                }
            } catch (e) {
                console.error('‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ï‡•ã localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
            }
            applySettings();
        };

        const applySettings = () => {
            // Apply Language setting
            languageSelect.value = appSettings.language;
            loadVoices(); // Reload voices based on selected language

            // Apply Text Size setting
            outputTextContent.style.fontSize = appSettings.textSize;
            questionInput.style.fontSize = appSettings.textSize; // Apply to input as well
            const selectedSizeRadio = textSizeOptions.querySelector(`input[value="${appSettings.textSize}"]`);
            if (selectedSizeRadio) {
                selectedSizeRadio.checked = true;
            }

            // Apply Ad-Free setting
            if (appSettings.isAdFree) {
                allAdDivs.forEach(adDiv => adDiv.style.display = 'none');
                removeAdsBtn.disabled = true;
                removeAdsBtn.innerHTML = '<i class="fas fa-check-circle"></i> ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§';
                removeAdsBtn.title = '‡§Ü‡§™ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§ï‡§æ ‡§Ü‡§®‡§Ç‡§¶ ‡§≤‡•á ‡§∞‡§π‡•á ‡§π‡•à‡§Ç!';
            } else {
                allAdDivs.forEach(adDiv => adDiv.style.display = 'flex'); // Ensure ads are visible if not ad-free
                removeAdsBtn.disabled = false;
                removeAdsBtn.innerHTML = '<i class="fas fa-ban"></i> ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç (‚Çπ49)';
                removeAdsBtn.title = '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‚Çπ49 ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç';
            }
        };

        // --- History Persistence Functions ---
        const saveHistory = () => {
            try {
                localStorage.setItem('aiSolverHistory', JSON.stringify(history));
                console.log('‡§á‡§§‡§ø‡§π‡§æ‡§∏ localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ‡•§');
            } catch (e) {
                console.error('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§ï‡•ã localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
                alert('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§∂‡§æ‡§Ø‡§¶ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§≠‡§∞‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à‡•§');
            }
        };

        const loadHistory = () => {
            try {
                const storedHistory = localStorage.getItem('aiSolverHistory');
                if (storedHistory) {
                    history = JSON.parse(storedHistory);
                    console.log('‡§á‡§§‡§ø‡§π‡§æ‡§∏ localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü‡•§');
                }
            } catch (e) {
                console.error('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§ï‡•ã localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
                history = []; // Reset history if loading fails
            }
        };

        // --- Favorites Persistence Functions (New) ---
        const saveFavorites = () => {
            try {
                localStorage.setItem('aiSolverFavorites', JSON.stringify(favorites));
                console.log('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ‡•§');
            } catch (e) {
                console.error('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ï‡•ã localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
                alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§');
            }
        };

        const loadFavorites = () => {
            try {
                const storedFavorites = localStorage.getItem('aiSolverFavorites');
                if (storedFavorites) {
                    favorites = JSON.parse(storedFavorites);
                    console.log('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü‡•§');
                }
            } catch (e) {
                console.error('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ï‡•ã localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
                favorites = []; // Reset if loading fails
            }
        };

        const isFavorited = (entry) => {
            return favorites.some(fav => 
                fav.question === entry.question && 
                fav.answer === entry.answer &&
                fav.imageUsed === entry.imageUsed
                // We're not checking timestamp here because the content is what matters for "favorited" state
            );
        };

        const addToFavorites = (entry) => {
            // Check for duplicates based on question, answer, and imageUsed status
            if (!isFavorited(entry)) {
                favorites.unshift(entry); // Add to the beginning
                saveFavorites();
                return true; // Successfully added
            }
            return false; // Already exists
        };

        const removeFromFavorites = (entryToRemove) => {
            const initialLength = favorites.length;
            favorites = favorites.filter(fav => 
                !(fav.question === entryToRemove.question && 
                  fav.answer === entryToRemove.answer &&
                  fav.timestamp === entryToRemove.timestamp) // Match by timestamp too for exact removal
            );
            if (favorites.length < initialLength) {
                saveFavorites();
                return true;
            }
            return false;
        };


        // --- Helper Functions ---

        // Enable/Disable all interaction elements
        const setInteractionState = (disabled) => {
            sendBtn.disabled = disabled;
            questionInput.disabled = disabled;
            micBtn.disabled = disabled || !SpeechRecognition;
            cameraBtn.disabled = disabled;
            clearInputBtn.disabled = disabled;
            imageInput.disabled = disabled;
            shareResultBtn.disabled = disabled;
            document.querySelector('.file-input-wrapper').classList.toggle('disabled', disabled);
        };

        // Camera functionality
        const startCamera = async () => {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = currentStream;
                cameraModal.classList.add('show');
                
                const videoTrack = currentStream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    flashBtn.style.display = 'flex';
                    flashBtn.style.background = flashEnabled ? 
                        'linear-gradient(135deg, #ffd700 0%, #ffb300 100%)' : 
                        'rgba(255, 255, 255, 0.9)';
                } else {
                    flashBtn.style.display = 'none';
                }

            } catch (error) {
                console.error('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                outputTextContent.innerHTML = `üì∑ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
            }
        };

        const stopCamera = () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraModal.classList.remove('show');
        };

        const switchCamera = async () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            await startCamera();
        };

        const toggleFlash = async () => {
            if (currentStream) {
                const videoTrack = currentStream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();
                
                if (capabilities.torch) {
                    flashEnabled = !flashEnabled;
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: flashEnabled }]
                        });
                        flashBtn.style.background = flashEnabled ? 
                            'linear-gradient(135deg, #ffd700 0%, #ffb300 100%)' : 
                            'rgba(255, 255, 255, 0.9)';
                    } catch (error) {
                        console.error('‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                        outputTextContent.innerHTML = '‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§á‡§∏‡•á ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à ‡§π‡•à‡•§';
                    }
                } else {
                    outputTextContent.innerHTML = '‡§á‡§∏ ‡§ï‡•à‡§Æ‡§∞‡•á ‡§™‡§∞ ‡§´‡§º‡•ç‡§≤‡•à‡§∂ (‡§ü‡•â‡§∞‡•ç‡§ö) ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§';
                }
            }
        };

        const capturePhoto = () => {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
            
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            imagePreview.src = dataURL;
            imagePreview.style.display = 'block';
            
            uploadedImageData = {
                mimeType: 'image/jpeg',
                data: dataURL.split(',')[1]
            };
            
            questionInput.placeholder = "üì∑üñºÔ∏è ‡§´‡•ã‡§ü‡•ã ‡§ñ‡•Ä‡§Ç‡§ö‡•Ä ‡§ó‡§à! ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)";
            outputTextContent.innerHTML = `üì∑ ‡§´‡•ã‡§ü‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡•Ä ‡§ó‡§à! ‡§Ö‡§¨ ‡§Ü‡§™ ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§`;
            
            stopCamera();
        };

        // --- Speech Synthesis Functions ---
        const loadVoices = () => {
            const voices = window.speechSynthesis.getVoices();
            const preferredLang = appSettings.language === 'auto' ? navigator.language || 'en-US' : appSettings.language;
            
            // Try to find a voice matching the selected language
            selectedTTSVoice = voices.find(voice => voice.lang.startsWith(preferredLang) || voice.name.includes(preferredLang.split('-')[0]));
            
            if (!selectedTTSVoice && preferredLang !== 'hi') { // Fallback to Hindi if not found and user didn't explicitly select Hindi
                selectedTTSVoice = voices.find(voice => voice.lang.startsWith('hi') || voice.name.includes('Hindi'));
            }
            if (!selectedTTSVoice) { // Fallback to English if Hindi not found
                selectedTTSVoice = voices.find(voice => voice.lang.startsWith('en')) || voices[0];
            }

            if (!selectedTTSVoice) {
                console.error("‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü-‡§ü‡•Ç-‡§∏‡•ç‡§™‡•Ä‡§ö ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§");
                speakerBtn.style.display = 'none';
                favoriteOutputBtn.style.display = 'none'; // Also hide favorite button if no TTS (implies no answer yet)
                document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.style.display = 'none');
            } else {
                console.log(`TTS voice selected: ${selectedTTSVoice.name} (${selectedTTSVoice.lang})`);
                // speakerBtn.style.display = 'flex'; // Show main speaker button if TTS is available (handled in sendBtn)
                document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.style.display = 'inline-flex'); 
            }
        };

        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices(); // Initial load
        } else {
            console.warn("‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•ç‡§™‡•Ä‡§ö ‡§∏‡§ø‡§Ç‡§•‡•á‡§∏‡§ø‡§∏ API ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§");
            speakerBtn.style.display = 'none';
            favoriteOutputBtn.style.display = 'none';
            document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.style.display = 'none');
        }

        const speakAnswer = (text, targetButton) => {
            if (!('speechSynthesis' in window) || !selectedTTSVoice) {
                console.error('‡§≠‡§æ‡§∑‡§£ ‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à (API ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à ‡§π‡•à)‡•§');
                alert('‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§™‡§æ‡§† ‡§∏‡•á ‡§µ‡§æ‡§ï‡•ç ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§Ü‡§µ‡§æ‡§ú‡§º‡•á‡§Ç ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à ‡§π‡•à‡§Ç‡•§');
                return;
            }

            stopSpeaking(); // Stop any ongoing speech and reset ALL speaker buttons

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = selectedTTSVoice;
            currentUtterance.lang = selectedTTSVoice.lang;
            currentUtterance.rate = 1;
            currentUtterance.pitch = 1;

            currentUtterance.onstart = () => {
                isSpeaking = true;
                if (targetButton) {
                    targetButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    targetButton.classList.add('playing');
                    targetButton.title = '‡§¨‡•ã‡§≤‡§®‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç';
                }
                console.log('‡§¨‡•ã‡§≤‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§Ü:', text.substring(0, Math.min(50, text.length)) + '...');
            };
            currentUtterance.onend = () => {
                isSpeaking = false;
                if (targetButton) {
                    targetButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    targetButton.classList.remove('playing');
                    targetButton.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                };
                console.log('‡§¨‡•ã‡§≤‡§®‡§æ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü‡•§');
            };
            currentUtterance.onerror = (event) => {
                console.error('‡§≠‡§æ‡§∑‡§£ ‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event);
                isSpeaking = false;
                if (targetButton) {
                    targetButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    targetButton.classList.remove('playing');
                    targetButton.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                }
                alert('‡§™‡§æ‡§† ‡§∏‡•á ‡§µ‡§æ‡§ï‡•ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: ' + event.error + '. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
            };

            window.speechSynthesis.speak(currentUtterance);
        };

        const stopSpeaking = () => {
            if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            isSpeaking = false;
            document.querySelectorAll('.history-speaker-btn, #speakerBtn').forEach(btn => {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.remove('playing');
                btn.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
            });
            // Also reset favoriteOutputBtn if it's currently showing filled heart
            favoriteOutputBtn.classList.remove('favorited');
            favoriteOutputBtn.innerHTML = '<i class="fas fa-heart"></i>';
        };


        // --- Enhanced AI Query Function ---
        const performAIQuery = async (text, imageData) => {

            let modelName = 'gemini-1.5-flash-latest'; // Using a more recent model
            const parts = [];
            let promptText = text.trim();

            // Add language instruction to the prompt
            if (appSettings.language && appSettings.language !== 'auto') {
                const langMap = { 'hi': 'Hindi', 'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German', 'ja': 'Japanese', 'ko': 'Korean', 'zh': 'Chinese', 'ar': 'Arabic', 'ru': 'Russian', 'pt': 'Portuguese', 'it': 'Italian', 'nl': 'Dutch', 'sv': 'Swedish', 'da': 'Danish', 'no': 'Norwegian', 'fi': 'Finnish', 'pl': 'Polish', 'tr': 'Turkish', 'th': 'Thai', 'vi': 'Vientamese', 'id': 'Indonesian', 'ms': 'Malay', 'tl': 'Filipino', 'bn': 'Bengali', 'ur': 'Urd¬µ', 'ta': 'Tamil', 'te': 'Telugu', 'mr': 'Marathi', 'gu': 'Gujarati', 'kn': 'Kannada', 'ml': 'Malayalam', 'pa': 'Punjabi', 'or': 'Odia', 'as': 'Assamese' };
                promptText = `Respond strictly in ${langMap[appSettings.language]}: ${promptText}`;
            }

            if (promptText) {
                if (imageData) {
                    promptText = `Analyze this image and answer: ${promptText}. Provide a clear, detailed response. If it's a math problem in the image, solve it step by step. If it's GK, provide factual information.`;
                } else {
                    const lowerCasePrompt = promptText.toLowerCase();
                    if (lowerCasePrompt.match(/(\d+\s*[\+\-\*\/xX√∑]\s*\d+)|(solve)|(calculate)|(what is the result of)|(evaluate)|(integral)|(derivative)|(equation)|(find x)|(simplify)/i) || (appSettings.language === 'hi' && lowerCasePrompt.match(/(‡§π‡§≤ ‡§ï‡§∞‡•ã)|(‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•ã)|(‡§®‡§ø‡§ï‡§æ‡§≤‡•ã)|(‡§∏‡§Æ‡•Ä‡§ï‡§∞‡§£)|(‡§ó‡§£‡§ø‡§§)|(‡§ú‡•ã‡§°‡§º)|(‡§ò‡§ü‡§æ‡§®‡§æ)|(‡§ó‡•Å‡§£‡§æ)|(‡§≠‡§æ‡§ó)/i))) {
                        promptText = `Solve this math problem step by step with clear explanations: ${promptText}`;
                    } else if (lowerCasePrompt.match(/(who is)|(what is)|(tell me about)|(define)|(fact)|(describe)|(explain)|(history of)|(when did)|(where is)|(what are)|(list)|(quiz)|(gk)|(general knowledge)|(‡§¨‡§§‡§æ‡§ì)|(‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à)|(‡§ï‡•å‡§® ‡§π‡•à)|(‡§ï‡§¨)|(‡§ï‡§π‡§æ‡§Ç)|(‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•ã)/i)) {
                        promptText = `Answer this general knowledge question with accurate, informative details: ${promptText}`;
                    } else {
                        promptText = `Provide a helpful and comprehensive answer to: ${promptText}`;
                    }
                }
                parts.push({ text: promptText });
            }

            if (imageData) {
                parts.push({
                    inlineData: {
                        mimeType: imageData.mimeType,
                        data: imageData.data
                    }
                });
            }

            if (parts.length === 0) {
                return '‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§';
            }

            const API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: parts }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 1000,
                            topP: 0.8,
                            topK: 40
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                        ]
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ:', errorData);
                    
                    switch (response.status) {
                        case 400:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Ø‡§æ ‡§á‡§®‡§™‡•Å‡§ü‡•§ ${errorData.error?.message || ''} ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§`;
                        case 403:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä API ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§î‡§∞ ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                        case 429:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§¶‡§∞ ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡§æ‡§∞ ‡§π‡•ã ‡§ó‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                        case 500:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                        default:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (${response.status}): ${errorData.error?.message || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à'}`;
                    }
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts && 
                    data.candidates[0].content.parts.length > 0 && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text.trim();
                } else {
                    console.warn('‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ API ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§Ø‡§æ ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä:', data);
                    if (data.promptFeedback && data.promptFeedback.blockReason) {
                        return `‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß: ${data.promptFeedback.blockReason}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§`;
                    }
                    return "‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à‡•§ ‡§Ø‡§π ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Ø‡§æ ‡§è‡§ï ‡§ñ‡§æ‡§≤‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§";
                }

            } catch (error) {
                console.error('AI ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                if (error.message.includes('Failed to fetch')) {
                    return `‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§™‡•É‡§∑‡•ç‡§† HTTPS ‡§™‡§∞ ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`;
                }
                return `‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`;
            }
        };

        // Function to add query/answer to history
        const addToHistory = (question, answer, imageUsed = false) => {
            const timestamp = new Date().toLocaleString();
            const entry = { question, answer, imageUsed, timestamp };
            history.unshift(entry);
            if (history.length > 50) { // Keep history manageable, e.g., max 50 entries
                history.pop();
            }
            saveHistory(); // Save to localStorage immediately
            return entry; // Return the created entry
        };

        // Function to generate and save PDF for a single history or favorite entry
        const generateSinglePdf = async (entry) => {
            stopSpeaking();
            const tempDiv = document.createElement('div');
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.style.padding = '20px';
            tempDiv.style.color = '#333';
            tempDiv.style.lineHeight = '1.6';

            tempDiv.innerHTML = `
                <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">${APP_NAME}</h2>
                <h3 style="color: #764ba2;">‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</h3>
                <p>${entry.question || (entry.imageUsed ? '‡§õ‡§µ‡§ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç')}</p>
                <h3 style="color: #764ba2;">‡§â‡§§‡•ç‡§§‡§∞:</h3>
                <p>${entry.answer.replace(/\n/g, '<br>')}</p>
                <small style="display: block; text-align: right; margin-top: 20px; color: #777;">‡§§‡§ø‡§•‡§ø: ${entry.timestamp}</small>
                <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.8em; color: #999;">
                    <p style="margin: 5px 0;">¬©${APP_NAME}</p>
                    <p style="margin: 5px 0;"><a href="${APP_URL}" target="_blank" style="color: #667eea; text-decoration: none;">‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ 1 ‡§Æ‡§ø‡§®‡§ü ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§Ø‡•á Ai ‡§∏‡•á -‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</a></p>
                </div>
            `;

            const opt = {
                margin: 0.5,
                filename: `YADAV_Sir_AI_Solver_${entry.timestamp.replace(/[:\/,\s]/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Determine which modal is active to show loading and restore
            const activeModal = historyModal.classList.contains('show') ? historyModal : (favoritesModal.classList.contains('show') ? favoritesModal : null);
            let originalContent = '';
            let restoreDisplayFunc = null;

            if (activeModal) {
                const modalContentElem = activeModal.querySelector('.modal-content');
                originalContent = modalContentElem.innerHTML;
                restoreDisplayFunc = activeModal === historyModal ? displayHistory : displayFavorites;

                // Show loading state in active modal
                modalContentElem.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <div class="loading" style="width: 40px; height: 40px; border-width: 5px; margin: 0 auto 20px;"></div>
                        <p style="color: #667eea; font-size: 1.2em;">PDF ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                    </div>
                `;
                // Disable all relevant buttons in modals
                downloadHistoryPdfBtn.disabled = true;
                document.querySelectorAll('.single-pdf-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.disabled = true);
            }

            try {
                await html2pdf().from(tempDiv).set(opt).save();
                console.log('‡§è‡§ï‡§≤ PDF ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü!');
            } catch (error) {
                console.error('‡§è‡§ï‡§≤ PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤ ‡§π‡•Å‡§Ü:', error);
                alert('PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
            } finally {
                if (activeModal && restoreDisplayFunc) {
                    // Restore original content and re-enable buttons
                    activeModal.querySelector('.modal-content').innerHTML = originalContent;
                    restoreDisplayFunc(); // Re-render to re-attach event listeners and re-enable buttons
                }
            }
        };


        // Function to display history in the modal
        const displayHistory = () => {
            historyList.innerHTML = ''; // Clear existing list items
            if (history.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<em>‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç! ü§î</em>';
                historyList.appendChild(li);
                downloadHistoryPdfBtn.disabled = true; // Disable PDF button if no history
            } else {
                downloadHistoryPdfBtn.disabled = false; // Enable PDF button if history exists
            }

            history.forEach((entry, index) => {
                const li = document.createElement('li');
                let questionDisplay = entry.question || '';
                if (entry.imageUsed) {
                    questionDisplay = `üñºÔ∏è ${questionDisplay.length > 0 ? questionDisplay : '‡§õ‡§µ‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®'}`;
                }
                if (questionDisplay.length > 100) {
                    questionDisplay = questionDisplay.substring(0, 100) + '...';
                }

                const questionDiv = document.createElement('div');
                questionDiv.innerHTML = `<strong>‡§™‡•ç‡§∞:</strong> ${questionDisplay}`;
                li.appendChild(questionDiv);

                const answerContentDiv = document.createElement('div');
                answerContentDiv.classList.add('answer-content');

                const answerTextWrapper = document.createElement('span');
                answerTextWrapper.classList.add('answer-text-wrapper');
                answerTextWrapper.textContent = `‡§â: ${entry.answer}`; 
                answerContentDiv.appendChild(answerTextWrapper);

                const historySpeakerBtn = document.createElement('button');
                historySpeakerBtn.classList.add('history-speaker-btn');
                historySpeakerBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                historySpeakerBtn.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                
                if ('speechSynthesis' in window && selectedTTSVoice) {
                    historySpeakerBtn.style.display = 'inline-flex'; 
                } else {
                    historySpeakerBtn.style.display = 'none';
                }

                historySpeakerBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (historySpeakerBtn.classList.contains('playing')) {
                        stopSpeaking();
                    } else {
                        speakAnswer(entry.answer, historySpeakerBtn);
                    }
                });
                answerContentDiv.appendChild(historySpeakerBtn);

                // Add individual PDF download button
                const singlePdfBtn = document.createElement('button');
                singlePdfBtn.classList.add('single-pdf-btn');
                singlePdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                singlePdfBtn.title = '‡§Ø‡§π ‡§â‡§§‡•ç‡§§‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
                singlePdfBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    generateSinglePdf(entry); // Pass the specific entry to the function
                });
                answerContentDiv.appendChild(singlePdfBtn);

                // Add Favorite/Unfavorite button to history items
                const favBtn = document.createElement('button');
                favBtn.classList.add('history-speaker-btn'); // Reusing some styles
                favBtn.style.background = 'rgba(240, 98, 146, 0.2)'; // Pink for favorite
                favBtn.style.color = '#f06292';

                if (isFavorited(entry)) {
                    favBtn.innerHTML = '<i class="fas fa-heart"></i>'; // Filled heart
                    favBtn.title = '‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Å';
                    favBtn.classList.add('favorited');
                } else {
                    favBtn.innerHTML = '<i class="far fa-heart"></i>'; // Empty heart
                    favBtn.title = '‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç';
                    favBtn.classList.remove('favorited');
                }

                favBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (isFavorited(entry)) {
                        removeFromFavorites(entry);
                        alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
                    } else {
                        addToFavorites(entry);
                        alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!');
                    }
                    displayHistory(); // Re-render history to update heart icons
                    displayFavorites(); // Re-render favorites if it's open
                });
                answerContentDiv.appendChild(favBtn);


                li.appendChild(answerContentDiv);

                const timestampSmall = document.createElement('small');
                timestampSmall.innerHTML = entry.timestamp;
                li.appendChild(timestampSmall);

                historyList.appendChild(li);
            });
        };

        // Function to display favorites in the modal (New)
        const displayFavorites = () => {
            favoritesList.innerHTML = ''; // Clear existing list items
            if (favorites.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<em>‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§∏‡•á ‡§Ø‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç! ‚ù§Ô∏è</em>';
                favoritesList.appendChild(li);
            } else {
                favorites.forEach((entry, index) => {
                    const li = document.createElement('li');
                    let questionDisplay = entry.question || '';
                    if (entry.imageUsed) {
                        questionDisplay = `üñºÔ∏è ${questionDisplay.length > 0 ? questionDisplay : '‡§õ‡§µ‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®'}`;
                    }
                    if (questionDisplay.length > 100) {
                        questionDisplay = questionDisplay.substring(0, 100) + '...';
                    }

                    const questionDiv = document.createElement('div');
                    questionDiv.innerHTML = `<strong>‡§™‡•ç‡§∞:</strong> ${questionDisplay}`;
                    li.appendChild(questionDiv);

                    const answerContentDiv = document.createElement('div');
                    answerContentDiv.classList.add('answer-content');

                    const answerTextWrapper = document.createElement('span');
                    answerTextWrapper.classList.add('answer-text-wrapper');
                    answerTextWrapper.textContent = `‡§â: ${entry.answer}`;
                    answerContentDiv.appendChild(answerTextWrapper);

                    // Add a speaker button for favorite items
                    const favSpeakerBtn = document.createElement('button');
                    favSpeakerBtn.classList.add('history-speaker-btn'); // Reuse history-speaker-btn styles
                    favSpeakerBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    favSpeakerBtn.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                    
                    if ('speechSynthesis' in window && selectedTTSVoice) {
                        favSpeakerBtn.style.display = 'inline-flex'; 
                    } else {
                        favSpeakerBtn.style.display = 'none';
                    }

                    favSpeakerBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        if (favSpeakerBtn.classList.contains('playing')) {
                            stopSpeaking();
                        } else {
                            speakAnswer(entry.answer, favSpeakerBtn);
                        }
                    });
                    answerContentDiv.appendChild(favSpeakerBtn);

                    // Add a PDF button for favorite items
                    const favPdfBtn = document.createElement('button');
                    favPdfBtn.classList.add('single-pdf-btn'); // Reuse single-pdf-btn styles
                    favPdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                    favPdfBtn.title = '‡§Ø‡§π ‡§â‡§§‡•ç‡§§‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
                    favPdfBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        generateSinglePdf(entry); // Reuse the single PDF generation function
                    });
                    answerContentDiv.appendChild(favPdfBtn);

                    // Add a "Remove from Favorites" button
                    const removeFavBtn = document.createElement('button');
                    removeFavBtn.classList.add('single-pdf-btn'); // Reusing existing button styles
                    removeFavBtn.style.background = 'rgba(255, 99, 71, 0.2)'; // Custom color for remove
                    removeFavBtn.style.color = '#ff6347';
                    removeFavBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    removeFavBtn.title = '‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Å';
                    removeFavBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                            removeFromFavorites(entry);
                            alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
                            displayFavorites(); // Re-render the list
                            displayHistory(); // Re-render history to update heart icons
                        }
                    });
                    answerContentDiv.appendChild(removeFavBtn);

                    li.appendChild(answerContentDiv);

                    const timestampSmall = document.createElement('small');
                    timestampSmall.innerHTML = entry.timestamp;
                    li.appendChild(timestampSmall);

                    favoritesList.appendChild(li);
                });
            }
        };


        // Enhanced loading animation
        const showLoading = () => {
            outputTextContent.innerHTML = '<div class="loading"></div> <span style="margin-left: 10px;">‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§∞‡•Å‡§ï‡•á " YADAV Sir " ‡§Ü‡§™‡§ï‡•á question ‡§ï‡§æ answer ‡§ú‡§∞‡•Ç‡§∞ ‡§¶‡•á‡§ó‡§æ ,  Wait for a while...</span>';
            // Also update placeholder if needed
            if (outputPlaceholder) {
                outputPlaceholder.style.display = 'none';
            }
            favoriteOutputBtn.style.display = 'none'; // Hide favorite button during loading
        };

        // Function to prepare input for a new query type
        const prepareNewQuery = (type) => {
            questionInput.value = '';
            uploadedImageData = null;
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            outputTextContent.innerHTML = '<div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>';
            speakerBtn.style.display = 'none'; // Hide speaker button on clear
            favoriteOutputBtn.style.display = 'none'; // Hide favorite button on clear
            lastAnsweredQuestion = null;
            lastAnsweredText = null;
            lastAnsweredImageUsed = false;

            mainMenuModal.classList.remove('show');
            stopSpeaking();
            
            if (type === 'gk') {
                questionInput.placeholder = 'üí° ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á, "‡§ó‡•Å‡§∞‡•Å‡§§‡•ç‡§µ‡§æ‡§ï‡§∞‡•ç‡§∑‡§£ ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§ø‡§∏‡§®‡•á ‡§ï‡•Ä?")';
                outputTextContent.innerHTML = `<div id="outputPlaceholder">‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞! ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§</div>`;
            } else if (type === 'math') {
                questionInput.placeholder = 'üî¢ ‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§™‡•Ç‡§õ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á, "2x + 5 = 11 ‡§π‡§≤ ‡§ï‡§∞‡•á‡§Ç")';
                outputTextContent.innerHTML = `<div id="outputPlaceholder">‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞! ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§</div>`;
            } else {
                questionInput.placeholder = '‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!';
                outputTextContent.innerHTML = '<div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>';
            }
            questionInput.focus();
        };

        // --- Event Listeners ---

        // Camera button
        cameraBtn.addEventListener('click', startCamera);

        // Camera controls
        captureBtn.addEventListener('click', capturePhoto);
        closeCameraBtn.addEventListener('click', stopCamera);
        switchCameraBtn.addEventListener('click', switchCamera);
        flashBtn.addEventListener('click', toggleFlash);

        // Close camera modal when clicking outside
        cameraModal.addEventListener('click', (e) => {
            if (e.target === cameraModal) {
                stopCamera();
            }
        });

        // Microphone button
        micBtn.addEventListener('click', () => {
            if (!recognition) return;

            micBtn.disabled = true;
            micBtn.style.background = '#ffd700';
            micBtn.querySelector('i').classList.add('fa-beat');
            stopSpeaking();
            speakerBtn.style.display = 'none';
            favoriteOutputBtn.style.display = 'none'; // Hide favorite button during mic input

            recognition.start();
            outputTextContent.innerHTML = 'üîä ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§';
            questionInput.placeholder = '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à...';
        });

        if (recognition) {
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                questionInput.value = speechResult;
                outputTextContent.innerHTML = '<div id="outputPlaceholder">üîä ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≠‡•á‡§ú‡•á‡§Ç ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>';
            };

            recognition.onend = () => {
                micBtn.disabled = false;
                micBtn.style.background = '';
                micBtn.querySelector('i').classList.remove('fa-beat');
                questionInput.placeholder = '‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!';
            };

            recognition.onerror = (event) => {
                console.error('‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event.error);
                outputTextContent.innerHTML = `üîä ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.error}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                micBtn.disabled = false;
                micBtn.style.background = '';
                micBtn.querySelector('i').classList.remove('fa-beat');
            };
        }

        // Image Input (File Upload)
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    imagePreview.src = reader.result;
                    imagePreview.style.display = 'block';
                    uploadedImageData = {
                        mimeType: file.type,
                        data: reader.result.split(',')[1]
                    };
                    questionInput.placeholder = `üñºÔ∏è ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§ó‡§à! ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)`;
                    outputTextContent.innerHTML = `<div id="outputPlaceholder">üñºÔ∏è ‡§õ‡§µ‡§ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•Å‡§à! ‡§Ö‡§¨ ‡§Ü‡§™ ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</div>`;
                    stopSpeaking();
                    speakerBtn.style.display = 'none';
                    favoriteOutputBtn.style.display = 'none'; // Hide favorite button on new image upload
                    lastAnsweredQuestion = null; // Reset last answer
                    lastAnsweredText = null;
                    lastAnsweredImageUsed = false;
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
                uploadedImageData = null;
                questionInput.placeholder = `‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!`;
                outputTextContent.innerHTML = '<div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>';
                stopSpeaking();
                speakerBtn.style.display = 'none';
                favoriteOutputBtn.style.display = 'none'; // Hide favorite button
                lastAnsweredQuestion = null; // Reset last answer
                lastAnsweredText = null;
                lastAnsweredImageUsed = false;
            }
        });

        // Clear Input Button
        clearInputBtn.addEventListener('click', () => {
            prepareNewQuery('general');
            imageInput.value = '';
            stopSpeaking();
            speakerBtn.style.display = 'none';
            favoriteOutputBtn.style.display = 'none';
        });

        // Send/Get Answer Button
        sendBtn.addEventListener('click', async () => {
            const textQuestion = questionInput.value.trim();

            if (!textQuestion && !uploadedImageData) {
                outputTextContent.innerHTML = '<div id="outputPlaceholder">üí° ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç!</div>';
                return;
            }

            showLoading();
            setInteractionState(true);
            stopSpeaking();
            speakerBtn.style.display = 'none';
            favoriteOutputBtn.style.display = 'none'; // Hide favorite button before new answer

            try {
                const answer = await performAIQuery(textQuestion, uploadedImageData);
                outputTextContent.innerHTML = answer.replace(/\n/g, '<br>');

                const isNotError = !answer.startsWith("API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:") && !answer.startsWith("‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:") && !answer.startsWith("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:") && !answer.startsWith("‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß:");

                if (isNotError) {
                    const newEntry = addToHistory(textQuestion, answer, !!uploadedImageData);
                    lastAnsweredQuestion = newEntry.question;
                    lastAnsweredText = newEntry.answer;
                    lastAnsweredImageUsed = newEntry.imageUsed;

                    // Show speaker and favorite buttons only if a valid answer is returned
                    if ('speechSynthesis' in window && selectedTTSVoice) {
                        speakerBtn.style.display = 'flex';
                        speakerBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        speakerBtn.classList.remove('playing');
                    }
                    favoriteOutputBtn.style.display = 'flex';
                    favoriteOutputBtn.innerHTML = '<i class="far fa-heart"></i>'; // Default to empty heart
                    favoriteOutputBtn.classList.remove('favorited'); // Ensure it's not marked as favorited by default

                    // Check if this answer is already in favorites and update button
                    if (isFavorited(newEntry)) {
                        favoriteOutputBtn.innerHTML = '<i class="fas fa-heart"></i>';
                        favoriteOutputBtn.classList.add('favorited');
                    }
                } else {
                    speakerBtn.style.display = 'none';
                    favoriteOutputBtn.style.display = 'none';
                    lastAnsweredQuestion = null; // Reset last answer on error
                    lastAnsweredText = null;
                    lastAnsweredImageUsed = false;
                }

            } finally {
                setInteractionState(false);
            }
        });

        // --- Main Speaker Button Click Handler ---
        speakerBtn.addEventListener('click', () => {
            const answerText = outputTextContent.innerText.trim(); 
            if (isSpeaking) {
                stopSpeaking();
            } else {
                if (answerText && answerText !== outputPlaceholder.innerText.trim()) { 
                    speakAnswer(answerText, speakerBtn);
                } else {
                    console.warn('‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§∏‡•á ‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
                    alert('‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§∏‡•Å‡§®‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§');
                }
            }
        });

        // --- Favorite Output Button Click Handler (New) ---
        favoriteOutputBtn.addEventListener('click', () => {
            if (lastAnsweredQuestion && lastAnsweredText) {
                const entry = {
                    question: lastAnsweredQuestion,
                    answer: lastAnsweredText,
                    imageUsed: lastAnsweredImageUsed,
                    timestamp: new Date().toLocaleString() // Use current time for favorited time
                };

                if (isFavorited(entry)) {
                    // If already favorited, remove it
                    if (removeFromFavorites(entry)) {
                        favoriteOutputBtn.innerHTML = '<i class="far fa-heart"></i>'; // Empty heart
                        favoriteOutputBtn.classList.remove('favorited');
                        alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
                    } else {
                        alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡•á ‡§π‡§ü‡§æ‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§');
                    }
                } else {
                    // If not favorited, add it
                    if (addToFavorites(entry)) {
                        favoriteOutputBtn.innerHTML = '<i class="fas fa-heart"></i>'; // Filled heart
                        favoriteOutputBtn.classList.add('favorited');
                        alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!');
                    } else {
                        alert('‡§Ø‡§π ‡§Ü‡§á‡§ü‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Æ‡•á‡§Ç ‡§π‡•à!');
                    }
                }
                displayFavorites(); // Refresh favorites list if modal is open
                displayHistory(); // Refresh history list to update heart icons
            } else {
                alert('‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
            }
        });


        // --- Share Result Button Logic ---
        shareResultBtn.addEventListener('click', async () => {
            const currentQuestion = questionInput.value.trim();
            const currentAnswer = outputTextContent.querySelector('#outputPlaceholder') ? '' : outputTextContent.innerText.trim();

            if (!currentQuestion && !uploadedImageData && currentAnswer === '') {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç ‡§î‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç, ‡§´‡§ø‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§');
                return;
            }

            const shareText = `${APP_NAME}\n\n` +
                               `‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${currentQuestion || (uploadedImageData ? '‡§õ‡§µ‡§ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç')}\n\n` +
                               `‡§â‡§§‡•ç‡§§‡§∞: ${currentAnswer || '‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç'}\n\n` +
                               `‡§á‡§∏ AI ‡§ê‡§™ ‡§∏‡•á ‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ì‡§Ç ‡§ï‡§æ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§™‡§æ‡§è‡§Ç: ${APP_URL}`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `${APP_NAME} ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ`,
                        text: shareText,
                        url: APP_URL
                    });
                    console.log('‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡•Ä ‡§ó‡§à!');
                } catch (error) {
                    console.error('‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                    if (error.name !== 'AbortError') {
                        alert(`‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•: ${error.message}`);
                    }
                }
            } else {
                alert('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Ä‡§ß‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π‡§æ‡§Å ‡§™‡§æ‡§† ‡§π‡•à:\n\n' + shareText);
            }
        });


        // --- Main Menu Logic ---
        menuBtn.addEventListener('click', () => {
            mainMenuModal.classList.add('show');
            stopSpeaking();
        });

        closeMainMenuBtn.addEventListener('click', () => {
            mainMenuModal.classList.remove('show');
        });

        mainMenuModal.addEventListener('click', (e) => {
            if (e.target === mainMenuModal) {
                mainMenuModal.classList.remove('show');
            }
        });

        // Link History from Main Menu button
        openHistoryBtn.addEventListener('click', () => {
            mainMenuModal.classList.remove('show');
            stopSpeaking();
            displayHistory(); // Important: call displayHistory to refresh the list with speaker buttons
            historyModal.classList.add('show');
        });

        // Download App (PWA) button
        downloadAppBtn.addEventListener('click', () => {
            alert("‡§Ø‡§π ‡§è‡§ï ‡§µ‡•á‡§¨ ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§π‡•à! ‡§á‡§∏‡•á '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°' ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ö‡§™‡§®‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•á '‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç' ‡§Ø‡§æ '‡§ê‡§™ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç' ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§");
            mainMenuModal.classList.remove('show');
        });

        // New Share App Button Logic
        shareAppBtn.addEventListener('click', async () => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: APP_NAME,
                        text: '‡§ó‡§£‡§ø‡§§ ‡§î‡§∞ ‡§∞‡§ø‡§ú‡§®‡§ø‡§Ç‡§ó, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•á ‡§ù‡§ü‡§™‡§ü ‡§ú‡§µ‡§æ‡§¨ ‡§™‡§æ‡§è‡§Ç ‡§á‡§∏ YADAV Sir AI Math & GK Solver ‡§ê‡§™ ‡§∏‡•á!',
                        url: APP_URL
                    });
                    console.log('‡§ê‡§™ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
                } catch (error) {
                    console.error('‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                    if (error.name !== 'AbortError') {
                        alert(`‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•: ${error.message}`);
                    }
                }
            } else {
                alert('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Ä‡§ß‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§ê‡§™ ‡§ï‡§æ URL ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à:\n\n' + APP_URL + '\n\n‡§á‡§∏‡•á ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§');
            }
            mainMenuModal.classList.remove('show');
        });

        // New GK Question button
        newGkQuestionBtn.addEventListener('click', () => prepareNewQuery('gk'));

        // New Math Problem button
        newMathProblemBtn.addEventListener('click', () => prepareNewQuery('math'));

        // --- New Menu Option Event Listeners ---
        rateAppBtn.addEventListener('click', () => {
            alert('‡§á‡§∏ ‡§ê‡§™ ‡§ï‡•ã ‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ê‡§™ ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Å‡•§');
            // In a real app, you would redirect to your app's store page here
            // window.open('https://play.google.com/store/apps/details?id=your.app.package', '_blank');
            mainMenuModal.classList.remove('show');
        });

        privacyPolicyBtn.addEventListener('click', () => {
            window.open('https://yadavsir.vercel.app/privacy-policy.html', '_blank'); // Add your actual privacy policy URL here
            mainMenuModal.classList.remove('show');
        });

        // --- Settings Modal Logic ---
        settingsBtn.addEventListener('click', () => {
            mainMenuModal.classList.remove('show');
            stopSpeaking();
            settingsModal.classList.add('show');
            applySettings(); // Ensure settings are reflected when opening modal
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
            }
        });

        // Language selection handler
        languageSelect.addEventListener('change', (e) => {
            appSettings.language = e.target.value;
            saveSettings();
            loadVoices(); // Reload voices to match new language preference
            alert(`‡§≠‡§æ‡§∑‡§æ "${e.target.options[e.target.selectedIndex].text}" ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à‡•§`);
        });

        // Text size selection handler
        textSizeOptions.addEventListener('change', (e) => {
            if (e.target.name === 'textSize') {
                appSettings.textSize = e.target.value;
                saveSettings();
                applySettings(); // Apply new text size immediately
                alert(`‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§Ü‡§ï‡§æ‡§∞ ${e.target.value} ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`);
            }
        });

        // Remove Ads button handler
        removeAdsBtn.addEventListener('click', () => {
            if (appSettings.isAdFree) {
                alert('‡§Ü‡§™ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§ï‡§æ ‡§Ü‡§®‡§Ç‡§¶ ‡§≤‡•á ‡§∞‡§π‡•á ‡§π‡•à‡§Ç!');
                return;
            }
            const confirmPurchase = confirm('‡§Ø‡§π ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§Ü‡§™‡§ï‡•ã ‚Çπ49 ‡§ï‡•á ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡•á ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§™‡§∞ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? (‡§Ø‡§π ‡§è‡§ï ‡§°‡•á‡§Æ‡•ã ‡§π‡•à, ‡§ï‡•ã‡§à ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ)');
            if (confirmPurchase) {
                // Simulate successful payment
                appSettings.isAdFree = true;
                saveSettings();
                applySettings(); // Hide ads and update button
                alert('‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Ö‡§¨ ‡§Ü‡§™ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§ï‡§æ ‡§Ü‡§®‡§Ç‡§¶ ‡§≤‡•á‡§Ç‡§ó‡•á‡•§');
                settingsModal.classList.remove('show'); // Close settings after purchase
            } else {
                alert('‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®-‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§');
            }
        });

        // --- History Modal Logic ---
        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.remove('show');
            stopSpeaking();
        });

        // Close history modal when clicking outside
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.remove('show');
                stopSpeaking();
            }
        });

        // --- PDF Download All History Logic ---
        downloadHistoryPdfBtn.addEventListener('click', async () => {
            if (history.length === 0) {
                alert('‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
                return;
            }

            stopSpeaking(); // Stop any ongoing speech before PDF generation

            const tempDiv = document.createElement('div');
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.style.padding = '20px';
            tempDiv.style.color = '#333';
            tempDiv.style.lineHeight = '1.6';

            let historyContentHtml = `<h1 style="color: #667eea; text-align: center; margin-bottom: 20px;">${APP_NAME} - ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h1>`;
            history.forEach((entry, index) => {
                const questionDisplay = entry.question || (entry.imageUsed ? '‡§õ‡§µ‡§ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç');
                historyContentHtml += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                        <h3 style="color: #764ba2; margin-top: 0;">‡§™‡•ç‡§∞‡§∂‡•ç‡§® ${history.length - index}:</h3>
                        <p>${questionDisplay}</p>
                        <h3 style="color: #764ba2;">‡§â‡§§‡•ç‡§§‡§∞:</h3>
                        <p>${entry.answer.replace(/\n/g, '<br>')}</p>
                        <small style="display: block; text-align: right; color: #777;">‡§§‡§ø‡§•‡§ø: ${entry.timestamp}</small>
                    </div>
                `;
            });

            historyContentHtml += `
             <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.8em; color: #999;">
                <p style="margin: 5px 0;">¬©${APP_NAME}</p>
                <p style="margin: 5px 0;"><a href="${APP_URL}" target="_blank" style="color: #667eea; text-decoration: none;">‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ 1 ‡§Æ‡§ø‡§®‡§ü ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§Ø‡•á Ai ‡§∏‡•á -‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</a></p>
            </div>
             `;
            tempDiv.innerHTML = historyContentHtml;


            const opt = {
                margin: 0.5,
                filename: 'YADAV_Sir_AI_Solver_All_History.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Show a temporary loading message in the modal
            const historyModalContent = historyModal.querySelector('.modal-content');
            const originalContent = historyModalContent.innerHTML;
            historyModalContent.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div class="loading" style="width: 40px; height: 40px; border-width: 5px; margin: 0 auto 20px;"></div>
                    <p style="color: #667eea; font-size: 1.2em;">PDF ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                </div>
            `;
            downloadHistoryPdfBtn.disabled = true; // Disable button during process
            document.querySelectorAll('.single-pdf-btn').forEach(btn => btn.disabled = true); // Disable individual PDF buttons

            try {
                await html2pdf().from(tempDiv).set(opt).save();
                console.log('‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü!');
            } catch (error) {
                console.error('PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤ ‡§π‡•Å‡§Ü:', error);
                alert('PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
            } finally {
                // Restore original content after PDF generation
                historyModalContent.innerHTML = originalContent;
                displayHistory(); // Re-render history list to re-attach event listeners and re-enable buttons
            }
        });

        // --- Favorites Modal Logic (New) ---
        openFavoritesBtn.addEventListener('click', () => {
            mainMenuModal.classList.remove('show');
            stopSpeaking();
            displayFavorites(); // Display current favorites
            favoritesModal.classList.add('show');
        });

        closeFavoritesBtn.addEventListener('click', () => {
            favoritesModal.classList.remove('show');
            stopSpeaking();
        });

        favoritesModal.addEventListener('click', (e) => {
            if (e.target === favoritesModal) {
                favoritesModal.classList.remove('show');
                stopSpeaking();
            }
        });


        // Initial setup: load history and display it
        loadSettings(); // Load settings first
        loadHistory();
        loadFavorites(); // Load favorites on startup
        displayHistory(); // Call once on load to show initial history
    });
</script>
</body>
</html>