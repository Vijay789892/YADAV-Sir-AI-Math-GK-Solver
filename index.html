<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math & GK Solver</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden; /* Prevent body scroll, container manages 100vh */
    }

    .container {
        width: 100%;
        max-width: 450px;
        height: 100vh; /* Full height on mobile */
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        overflow: hidden; /* Prevent container scroll, main/outputArea manage it */
    }

    header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.1em;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    header .menu-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.5em;
        cursor: pointer;
        padding: 8px;
        border-radius: 10%;
        transition: all 0.3s ease;
    }

    header .menu-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    header .app-title {
        font-weight: 600;
        font-size: 1.3em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        position: relative;
    }

    textarea#questionInput {
        flex-grow: 0;
        width: calc(100% - 30px);
        min-height: 120px;
        border: 2px solid transparent;
        border-radius: 15px;
        padding: 20px;
        font-size: 1.1em;
        resize: none;
        outline: none;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    textarea#questionInput:focus {
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .input-options {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
    }

    .action-buttons button, .file-input-wrapper {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        width: 55px;
        height: 55px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.4em;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .action-buttons button:hover, .file-input-wrapper:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
    }

    .action-buttons button:disabled, .file-input-wrapper.disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    #imagePreview {
        max-width: 100%;
        max-height: 120px;
        margin: 10px 0;
        border-radius: 10px;
        display: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        object-fit: contain;
    }

    #outputArea {
        flex-grow: 1;
        flex-shrink: 1;
        flex-basis: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        font-size: 1.1em;
        word-wrap: break-word;
        overflow-y: auto;
        margin-top: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        min-height: 150px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    #outputTextContent {
        flex-grow: 1;
        overflow-y: auto;
        padding-bottom: 50px;
    }
    
    #outputPlaceholder {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 1.2em;
        font-weight: 500;
        opacity: 0.9;
    }

    /* Main Speaker Button Styles */
    #speakerBtn {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        color: white;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        z-index: 5;
    }

    #speakerBtn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 15px rgba(26, 188, 156, 0.4);
    }

    #speakerBtn.playing {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
    }

    /* History List Speaker Button Styles */
    .history-speaker-btn {
        background: rgba(102, 126, 234, 0.2);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: none; /* Controlled by JS based on TTS support */
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
        color: #667eea;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        margin-left: 10px;
        vertical-align: middle;
        flex-shrink: 0;
    }

    .history-speaker-btn:hover {
        background: rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .history-speaker-btn.playing {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        color: white;
    }

    /* PDF Download Button Style */
    #downloadHistoryPdfBtn {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); /* Orange for PDF */
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px 20px;
        font-size: 1em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 20px auto 0; /* Center it below history list */
        box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        transition: all 0.3s ease;
        width: calc(100% - 40px); /* Adjust width */
        max-width: 250px;
    }

    #downloadHistoryPdfBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);
    }
    #downloadHistoryPdfBtn:disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Individual PDF download button in history list */
    .single-pdf-btn {
        background: rgba(243, 156, 18, 0.2); /* Lighter orange */
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
        color: #f39c12;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        margin-left: 10px;
        vertical-align: middle;
        flex-shrink: 0;
    }

    .single-pdf-btn:hover {
        background: rgba(243, 156, 18, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }


    .send-btn {
        position: absolute;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.6em;
        color: white;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        transition: all 0.3s ease;
        z-index: 10;
    }

    .send-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6);
    }

    .send-btn:disabled {
        background: #a7a7a7;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Camera Modal Styles */
    .camera-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .camera-modal.show {
        visibility: visible;
        opacity: 1;
    }

    .camera-container {
        position: relative;
        max-width: 90%;
        max-height: 70%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        overflow: hidden;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    #cameraVideo {
        width: 100%;
        height: auto;
        border-radius: 18px;
        display: block;
    }

    .camera-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .camera-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .camera-btn:hover {
        transform: scale(1.1);
        background: white;
    }

    .capture-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        width: 70px;
        height: 70px;
        font-size: 1.8em;
    }

    .capture-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
    }

    .close-camera-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-camera-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    /* History Modal Styles */
    .history-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .history-modal.show {
        visibility: visible;
        opacity: 1;
    }

    /* Main Menu Modal Styles (similar to history-modal) */
    .main-menu-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .main-menu-modal.show {
        visibility: visible;
        opacity: 1;
    }

    .modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-content h2 {
        margin-top: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.5em;
    }

    .modal-content .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 107, 107, 0.1);
        border: none;
        font-size: 1.5em;
        color: #ff6b6b;
        cursor: pointer;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-content .close-btn:hover {
        background: rgba(255, 107, 107, 0.2);
        transform: scale(1.1);
    }

    #historyList, #mainMenuOptions {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #historyList li {
        background: rgba(102, 126, 234, 0.1);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 15px;
        font-size: 0.95em;
        line-height: 1.5;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    #historyList li:hover {
        background: rgba(102, 126, 234, 0.15);
        transform: translateX(5px);
    }

    #historyList li strong {
        color: #667eea;
    }

    #historyList li .answer-content {
        display: flex;
        align-items: center;
        margin-top: 8px;
        color: #555;
        word-break: break-word;
    }

    #historyList li .answer-text-wrapper {
        flex-grow: 1;
    }

    #historyList li small {
        display: block;
        margin-top: 8px;
        color: #999;
        font-size: 0.8em;
    }

    /* Main Menu Specific Styles */
    #mainMenuOptions li {
        margin-bottom: 10px;
    }

    #mainMenuOptions button {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        font-size: 1.1em;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    #mainMenuOptions button:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
    }

    #mainMenuOptions button i {
        font-size: 1.3em;
        color: #764ba2;
    }

    .menu-divider {
        height: 1px;
        background-color: rgba(0,0,0,0.1);
        margin: 20px 0;
    }

    /* Loading animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Ad Banner Styles */
    .ad-banner {
        width: 100%;
        padding: 10px; /* Some padding around the ad */
        box-sizing: border-box; /* Include padding in width */
        text-align: center; /* Center the ad if it's smaller than 100% */
        background: rgba(0, 0, 0, 0.05); /* Slight background to separate it */
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        margin-top: auto; /* Push it to the bottom if container is flex-column */
        min-height: 120px; /* Give it enough space for the ad (100px + padding) */
        display: flex; /* Use flex to center iframe if it's smaller */
        justify-content: center;
        align-items: center;
        overflow: hidden; /* Prevent overflow if ad content is too big */
    }

    /* Responsive design */
    @media (max-width: 480px) {
        .container {
            border-radius: 0;
            height: 100vh;
        }
        
        main {
            padding: 15px;
        }
        
        .send-btn {
            bottom: 290px;
            right: 20px;
        }

        #speakerBtn {
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            font-size: 1.1em;
        }

        .history-speaker-btn, .single-pdf-btn { /* Apply to both new buttons */
            width: 28px;
            height: 28px;
            font-size: 0.7em;
            margin-left: 8px;
        }

        #downloadHistoryPdfBtn {
            padding: 10px 15px;
            font-size: 0.9em;
            gap: 8px;
        }

        .camera-container {
            max-width: 95%;
            max-height: 60%;
        }

        .camera-controls {
            bottom: 10px;
            gap: 15px;
        }

        .camera-btn {
            width: 50px;
            height: 50px;
            font-size: 1.3em;
        }

        .capture-btn {
            width: 60px;
            height: 60px;
            font-size: 1.6em;
        }

        .modal-content {
            max-width: 95%;
            padding: 20px;
        }

        .ad-banner {
            padding: 8px;
            min-height: 100px; /* Slightly less height on mobile */
        }
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <button class="menu-btn" id="menuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="app-title">YADAV Sir AI </div> Math & GK Solver
        </header>
        <main>
            <textarea id="questionInput" placeholder="‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!"></textarea>
            
            <div class="input-options">
                <div class="action-buttons">
                    <button id="micBtn" title="‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡•ã‡§≤‡•á‡§Ç">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="cameraBtn" title="‡§õ‡§µ‡§ø ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button id="clearInputBtn" title="‡§á‡§®‡§™‡•Å‡§ü ‡§î‡§∞ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <!-- New Share Result Button -->
                    <button id="shareResultBtn" title="‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§î‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>

                <div class="file-input-wrapper">
                    <input type="file" id="imageInput" accept="image/*" title="‡§™‡•Ç‡§õ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">
                    <i class="fas fa-image"></i>
                </div>
            </div>
            
            <img id="imagePreview" alt="Image Preview">

            <div id="outputArea">
                <div id="outputTextContent">
                    <div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>
                </div>
                <button id="speakerBtn" title="‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            
            <button class="send-btn" id="sendBtn" title="‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç">
                <i class="fas fa-paper-plane"></i>
            </button>
        </main>

       <!-- Ad Banner - Added here -->
<script type="text/javascript">
	atOptions = {
		'key' : 'c9aeceda22757ef64f2eaa16f5041d5c',
		'format' : 'iframe',
		'height' : 90,
		'width' : 728,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/c9aeceda22757ef64f2eaa16f5041d5c/invoke.js"></script>

        <!-- Camera Modal -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <button class="close-camera-btn" id="closeCameraBtn">
                    <i class="fas fa-times"></i>
                </button>
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-btn" id="switchCameraBtn" title="‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="camera-btn capture-btn" id="captureBtn" title="‡§´‡•ã‡§ü‡•ã ‡§ñ‡•Ä‡§Ç‡§ö‡§ø‡§è">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="camera-btn" id="flashBtn" title="‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡•á‡§Ç">
                        <i class="fas fa-bolt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Menu Modal -->
        <div class="main-menu-modal" id="mainMenuModal">
            <div class="modal-content">
                <button class="close-btn" id="closeMainMenuBtn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>üöÄ ‡§Æ‡•á‡§®‡•Ç</h2>
                <ul id="mainMenuOptions">
                    <li><button id="openHistoryBtn"><i class="fas fa-history"></i> ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§î‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°  </button></li>
                 
                    <li><button id="newGkQuestionBtn"><i class="fas fa-brain"></i> ‡§®‡§Ø‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§®</button></li>
                    <li><button id="newMathProblemBtn"><i class="fas fa-calculator"></i> ‡§®‡§à ‡§ó‡§£‡§ø‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ</button></li>
                    <button class="cta-button" id="cta-menu-btn" onclick="window.open('https://yadavsir.vercel.app/', '_blank')">üìù YADAV Sir AI ‡§∏‡•á Doubt clear ‡§ï‡§∞‡•á</button>
            
                     <li class="menu-divider"></li>
                     <li><button id="downloadAppBtn"><i class="fas fa-download"></i> ‡§ê‡§™ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (PWA)</button></li>

                 <li>
      <a href="https://yadav-sir-learn-english-app.vercel.app/#" id="newMathProblemBtn" style="display: inline-block; padding: 10px 20px; background-color: #007BFF; color: white; border-radius: 5px; text-decoration: none;">
        <i class="fas fa-calculator"></i> ‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂ ‡§¨‡•ã‡§≤‡§®‡§æ ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§Æ‡§æ‡§§‡•ç‡§∞ 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç  ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á </a>
    </li>
                    <li><button id="shareAppBtn"><i class="fas fa-share-alt"></i> ‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</button></li>
                  </ul>
            </div>
        </div>

        <!-- History Modal -->
        <div class="history-modal" id="historyModal">
            <div class="modal-content">
                <button class="close-btn" id="closeHistoryBtn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>üìö ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h2>
                <!-- New PDF Download Button -->
                <button id="downloadHistoryPdfBtn" title="‡§™‡•Ç‡§∞‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">
                    <i class="fas fa-file-pdf"></i> ‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                </button>
                <ul id="historyList">
                    <!-- History items will be inserted here by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Get DOM elements
        const questionInput = document.getElementById('questionInput');
        const outputArea = document.getElementById('outputArea');
        const outputTextContent = document.getElementById('outputTextContent');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const micBtn = document.getElementById('micBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const clearInputBtn = document.getElementById('clearInputBtn');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const sendBtn = document.getElementById('sendBtn');
        const menuBtn = document.getElementById('menuBtn');
        
        // History elements
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const downloadHistoryPdfBtn = document.getElementById('downloadHistoryPdfBtn'); // New PDF button

        // Main Menu elements
        const mainMenuModal = document.getElementById('mainMenuModal');
        const closeMainMenuBtn = document.getElementById('closeMainMenuBtn');
        const openHistoryBtn = document.getElementById('openHistoryBtn');
        const downloadAppBtn = document.getElementById('downloadAppBtn');
        const shareAppBtn = document.getElementById('shareAppBtn');
        const newGkQuestionBtn = document.getElementById('newGkQuestionBtn');
        const newMathProblemBtn = document.getElementById('newMathProblemBtn');

        // Camera elements
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const flashBtn = document.getElementById('flashBtn');

        // Share Result Button
        const shareResultBtn = document.getElementById('shareResultBtn');

        // Speaker Button and Speech Synthesis (for main output)
        const speakerBtn = document.getElementById('speakerBtn');
        let currentUtterance = null;
        let isSpeaking = false;
        let hindiVoice = null;

        // API Configuration
        const GEMINI_API_KEY = 'AIzaSyDHy9J04dI8LdK1ijNJMrRXubJ5ucx9rdk'; // Keep your API key private in a real app

        // Variables for image data, history, and camera
        let uploadedImageData = null;
        let history = []; // This will be loaded from localStorage
        let currentStream = null;
        let currentFacingMode = 'environment';
        let flashEnabled = false;

        const APP_NAME = "YADAV Sir AI Math & GK Solver";
        const APP_URL = window.location.href; // Get current URL for linking

        // Speech Recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.interimResults = false;
            recognition.lang = 'hi-IN'; // Set default language to Hindi for better recognition
            recognition.continuous = false;
        } else {
            micBtn.disabled = true;
            micBtn.title = "‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à";
        }

        // --- History Persistence Functions ---
        const saveHistory = () => {
            try {
                localStorage.setItem('aiSolverHistory', JSON.stringify(history));
                console.log('History saved to localStorage.');
            } catch (e) {
                console.error('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§ï‡•ã localStorage ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
                alert('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§∂‡§æ‡§Ø‡§¶ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§≠‡§∞‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à‡•§');
            }
        };

        const loadHistory = () => {
            try {
                const storedHistory = localStorage.getItem('aiSolverHistory');
                if (storedHistory) {
                    history = JSON.parse(storedHistory);
                    console.log('History loaded from localStorage.');
                }
            } catch (e) {
                console.error('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§ï‡•ã localStorage ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à:', e);
                history = []; // Reset history if loading fails
            }
        };

        // --- Helper Functions ---

        // Enable/Disable all interaction elements
        const setInteractionState = (disabled) => {
            sendBtn.disabled = disabled;
            questionInput.disabled = disabled;
            micBtn.disabled = disabled || !SpeechRecognition;
            cameraBtn.disabled = disabled;
            clearInputBtn.disabled = disabled;
            imageInput.disabled = disabled;
            shareResultBtn.disabled = disabled;
            document.querySelector('.file-input-wrapper').classList.toggle('disabled', disabled);
        };

        // Camera functionality
        const startCamera = async () => {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = currentStream;
                cameraModal.classList.add('show');
                
                const videoTrack = currentStream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    flashBtn.style.display = 'flex';
                    flashBtn.style.background = flashEnabled ? 
                        'linear-gradient(135deg, #ffd700 0%, #ffb300 100%)' : 
                        'rgba(255, 255, 255, 0.9)';
                } else {
                    flashBtn.style.display = 'none';
                }

            } catch (error) {
                console.error('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                outputTextContent.innerHTML = `üì∑ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
            }
        };

        const stopCamera = () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraModal.classList.remove('show');
        };

        const switchCamera = async () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            await startCamera();
        };

        const toggleFlash = async () => {
            if (currentStream) {
                const videoTrack = currentStream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();
                
                if (capabilities.torch) {
                    flashEnabled = !flashEnabled;
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: flashEnabled }]
                        });
                        flashBtn.style.background = flashEnabled ? 
                            'linear-gradient(135deg, #ffd700 0%, #ffb300 100%)' : 
                            'rgba(255, 255, 255, 0.9)';
                    } catch (error) {
                        console.error('‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                        outputTextContent.innerHTML = '‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§á‡§∏‡•á ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à ‡§π‡•à‡•§';
                    }
                } else {
                    outputTextContent.innerHTML = '‡§á‡§∏ ‡§ï‡•à‡§Æ‡§∞‡•á ‡§™‡§∞ ‡§´‡§º‡•ç‡§≤‡•à‡§∂ (‡§ü‡•â‡§∞‡•ç‡§ö) ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§';
                }
            }
        };

        const capturePhoto = () => {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
            
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            imagePreview.src = dataURL;
            imagePreview.style.display = 'block';
            
            uploadedImageData = {
                mimeType: 'image/jpeg',
                data: dataURL.split(',')[1]
            };
            
            questionInput.placeholder = "üì∑üñºÔ∏è ‡§´‡•ã‡§ü‡•ã ‡§ñ‡•Ä‡§Ç‡§ö‡•Ä ‡§ó‡§à! ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)";
            outputTextContent.innerHTML = `üì∑ ‡§´‡•ã‡§ü‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡•Ä ‡§ó‡§à! ‡§Ö‡§¨ ‡§Ü‡§™ ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§`;
            
            stopCamera();
        };

        // --- Speech Synthesis Functions ---
        const loadVoices = () => {
            const voices = window.speechSynthesis.getVoices();
            // Try to find a Hindi voice first
            hindiVoice = voices.find(voice => voice.lang === 'hi-IN' || voice.name.includes('Hindi'));
            if (!hindiVoice) {
                console.warn("‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ü‡§µ‡§æ‡§ú (hi-IN) ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§Ü‡§µ‡§æ‡§ú ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                // Fallback to a suitable English voice if Hindi is not available
                hindiVoice = voices.find(voice => voice.lang.startsWith('en')) || voices[0];
            }
            if (!hindiVoice) {
                console.error("‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü-‡§ü‡•Ç-‡§∏‡•ç‡§™‡•Ä‡§ö ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§");
                speakerBtn.style.display = 'none';
                // Update visibility of existing history speaker buttons
                document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.style.display = 'none');
            } else {
                // If voices are loaded, ensure history speaker buttons are visible
                document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.style.display = 'inline-flex');
            }
        };

        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices(); // Initial load
        } else {
            console.warn("‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•ç‡§™‡•Ä‡§ö ‡§∏‡§ø‡§Ç‡§•‡•á‡§∏‡§ø‡§∏ API ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§");
            speakerBtn.style.display = 'none';
            document.querySelectorAll('.history-speaker-btn').forEach(btn => btn.style.display = 'none');
        }

        const speakAnswer = (text, targetButton) => {
            if (!('speechSynthesis' in window) || !hindiVoice) {
                console.error('‡§≠‡§æ‡§∑‡§£ ‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à (API ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à ‡§π‡•à)‡•§');
                alert('‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§™‡§æ‡§† ‡§∏‡•á ‡§µ‡§æ‡§ï‡•ç ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§Ü‡§µ‡§æ‡§ú‡§º‡•á‡§Ç ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à ‡§π‡•à‡§Ç‡•§');
                return;
            }

            stopSpeaking(); // Stop any ongoing speech and reset ALL speaker buttons

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = hindiVoice;
            currentUtterance.lang = hindiVoice.lang;
            currentUtterance.rate = 1;
            currentUtterance.pitch = 1;

            currentUtterance.onstart = () => {
                isSpeaking = true;
                if (targetButton) {
                    targetButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    targetButton.classList.add('playing');
                    targetButton.title = '‡§¨‡•ã‡§≤‡§®‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç';
                }
                console.log('‡§¨‡•ã‡§≤‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§Ü:', text.substring(0, Math.min(50, text.length)) + '...');
            };
            currentUtterance.onend = () => {
                isSpeaking = false;
                if (targetButton) {
                    targetButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    targetButton.classList.remove('playing');
                    targetButton.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                }
                console.log('‡§¨‡•ã‡§≤‡§®‡§æ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü‡•§');
            };
            currentUtterance.onerror = (event) => {
                console.error('‡§≠‡§æ‡§∑‡§£ ‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event);
                isSpeaking = false;
                if (targetButton) {
                    targetButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    targetButton.classList.remove('playing');
                    targetButton.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                }
                alert('‡§™‡§æ‡§† ‡§∏‡•á ‡§µ‡§æ‡§ï‡•ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: ' + event.error + '. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
            };

            window.speechSynthesis.speak(currentUtterance);
        };

        const stopSpeaking = () => {
            if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            isSpeaking = false;
            document.querySelectorAll('.history-speaker-btn, #speakerBtn').forEach(btn => {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.remove('playing');
                btn.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
            });
            console.log('‡§¨‡•ã‡§≤‡§®‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§');
        };


        // --- Enhanced AI Query Function ---
        const performAIQuery = async (text, imageData) => {

            let modelName = 'gemini-1.5-flash-latest'; // Using a more recent model
            const parts = [];

            if (text.trim()) {
                let prompt = text.trim();
                if (imageData) {
                    prompt = `Analyze this image and answer: ${prompt}. Provide a clear, detailed response. If it's a math problem in the image, solve it step by step. If it's GK, provide factual information.`;
                } else {
                    const lowerCasePrompt = prompt.toLowerCase();
                    if (lowerCasePrompt.match(/(\d+\s*[\+\-\*\/xX√∑]\s*\d+)|(solve)|(calculate)|(what is the result of)|(evaluate)|(integral)|(derivative)|(equation)|(find x)|(simplify)/i)) {
                        prompt = `Solve this math problem step by step with clear explanations: ${prompt}`;
                    } else if (lowerCasePrompt.match(/(who is)|(what is)|(tell me about)|(define)|(fact)|(describe)|(explain)|(history of)|(when did)|(where is)|(what are)|(list)|(quiz)|(gk)|(general knowledge)|(‡§¨‡§§‡§æ‡§ì)|(‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à)|(‡§ï‡•å‡§® ‡§π‡•à)|(‡§ï‡§¨)|(‡§ï‡§π‡§æ‡§Ç)/i)) {
                        prompt = `Answer this general knowledge question with accurate, informative details: ${prompt}`;
                    } else {
                        prompt = `Provide a helpful and comprehensive answer to: ${prompt}`;
                    }
                }
                parts.push({ text: prompt });
            }

            if (imageData) {
                parts.push({
                    inlineData: {
                        mimeType: imageData.mimeType,
                        data: imageData.data
                    }
                });
            }

            if (parts.length === 0) {
                return '‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§';
            }

            const API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: parts }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 1000,
                            topP: 0.8,
                            topK: 40
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                        ]
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ:', errorData);
                    
                    switch (response.status) {
                        case 400:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Ø‡§æ ‡§á‡§®‡§™‡•Å‡§ü‡•§ ${errorData.error?.message || ''} ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§`;
                        case 403:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä API ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§î‡§∞ ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                        case 429:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§¶‡§∞ ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡§æ‡§∞ ‡§π‡•ã ‡§ó‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                        case 500:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                        default:
                            return `API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (${response.status}): ${errorData.error?.message || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à'}`;
                    }
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts && 
                    data.candidates[0].content.parts.length > 0 && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text.trim();
                } else {
                    console.warn('‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ API ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§Ø‡§æ ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä:', data);
                    if (data.promptFeedback && data.promptFeedback.blockReason) {
                        return `‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß: ${data.promptFeedback.blockReason}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§`;
                    }
                    return "‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à‡•§ ‡§Ø‡§π ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Ø‡§æ ‡§è‡§ï ‡§ñ‡§æ‡§≤‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§";
                }

            } catch (error) {
                console.error('AI ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                if (error.message.includes('Failed to fetch')) {
                    return `‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§™‡•É‡§∑‡•ç‡§† HTTPS ‡§™‡§∞ ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`;
                }
                return `‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`;
            }
        };

        // Function to add query/answer to history
        const addToHistory = (question, answer, imageUsed = false) => {
            const timestamp = new Date().toLocaleString();
            history.unshift({ question, answer, imageUsed, timestamp });
            if (history.length > 50) { // Keep history manageable, e.g., max 50 entries
                history.pop();
            }
            saveHistory(); // Save to localStorage immediately
        };

        // Function to generate and save PDF for a single history entry
        const generateSinglePdf = async (entry) => {
            stopSpeaking();
            const tempDiv = document.createElement('div');
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.style.padding = '20px';
            tempDiv.style.color = '#333';
            tempDiv.style.lineHeight = '1.6';

            tempDiv.innerHTML = `
                <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">${APP_NAME}</h2>
                <h3 style="color: #764ba2;">‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</h3>
                <p>${entry.question || (entry.imageUsed ? '‡§õ‡§µ‡§ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç')}</p>
                <h3 style="color: #764ba2;">‡§â‡§§‡•ç‡§§‡§∞:</h3>
                <p>${entry.answer.replace(/\n/g, '<br>')}</p>
                <small style="display: block; text-align: right; margin-top: 20px; color: #777;">‡§§‡§ø‡§•‡§ø: ${entry.timestamp}</small>
                <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.8em; color: #999;">
                    <p style="margin: 5px 0;">¬©YADAV_Sir_AI_Solver_All_History</p>
                    <p style="margin: 5px 0;"><a href="${APP_URL}" target="_blank" style="color: #667eea; text-decoration: none;">‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ 1 ‡§Æ‡§ø‡§®‡§ü ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§Ø‡•á Ai ‡§∏‡•á -‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</a></p>
                </div>
            `;

            const opt = {
                margin: 0.5,
                filename: `YADAV_Sir_AI_Solver_${entry.timestamp.replace(/[:\/,\s]/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true }, // Set logging to false for cleaner console
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            const historyModalContent = historyModal.querySelector('.modal-content');
            const originalContent = historyModalContent.innerHTML;
            
            // Show loading state in history modal
            historyModalContent.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div class="loading" style="width: 40px; height: 40px; border-width: 5px; margin: 0 auto 20px;"></div>
                    <p style="color: #667eea; font-size: 1.2em;">PDF ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                </div>
            `;
            downloadHistoryPdfBtn.disabled = true; // Disable main PDF button
            document.querySelectorAll('.single-pdf-btn').forEach(btn => btn.disabled = true); // Disable individual PDF buttons

            try {
                await html2pdf().from(tempDiv).set(opt).save();
                console.log('‡§è‡§ï‡§≤ PDF ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü!');
            } catch (error) {
                console.error('‡§è‡§ï‡§≤ PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤ ‡§π‡•Å‡§Ü:', error);
                alert('PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
            } finally {
                // Restore original content and re-enable buttons
                historyModalContent.innerHTML = originalContent;
                displayHistory(); // Re-render to re-attach event listeners and re-enable buttons
            }
        };


        // Function to display history in the modal
        const displayHistory = () => {
            historyList.innerHTML = ''; // Clear existing list items
            if (history.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<em>‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç! ü§î</em>';
                historyList.appendChild(li);
                downloadHistoryPdfBtn.disabled = true; // Disable PDF button if no history
            } else {
                downloadHistoryPdfBtn.disabled = false; // Enable PDF button if history exists
            }

            history.forEach((entry, index) => {
                const li = document.createElement('li');
                let questionDisplay = entry.question || '';
                if (entry.imageUsed) {
                    questionDisplay = `üñºÔ∏è ${questionDisplay.length > 0 ? questionDisplay : '‡§õ‡§µ‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®'}`;
                }
                if (questionDisplay.length > 100) {
                    questionDisplay = questionDisplay.substring(0, 100) + '...';
                }

                const questionDiv = document.createElement('div');
                questionDiv.innerHTML = `<strong>‡§™‡•ç‡§∞:</strong> ${questionDisplay}`;
                li.appendChild(questionDiv);

                const answerContentDiv = document.createElement('div');
                answerContentDiv.classList.add('answer-content');

                const answerTextWrapper = document.createElement('span');
                answerTextWrapper.classList.add('answer-text-wrapper');
                answerTextWrapper.textContent = `‡§â: ${entry.answer}`; 
                answerContentDiv.appendChild(answerTextWrapper);

                const historySpeakerBtn = document.createElement('button');
                historySpeakerBtn.classList.add('history-speaker-btn');
                historySpeakerBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                historySpeakerBtn.title = '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç';
                
                if ('speechSynthesis' in window && hindiVoice) {
                    historySpeakerBtn.style.display = 'inline-flex'; 
                } else {
                    historySpeakerBtn.style.display = 'none';
                }

                historySpeakerBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (historySpeakerBtn.classList.contains('playing')) {
                        stopSpeaking();
                    } else {
                        speakAnswer(entry.answer, historySpeakerBtn);
                    }
                });
                answerContentDiv.appendChild(historySpeakerBtn);

                // Add individual PDF download button
                const singlePdfBtn = document.createElement('button');
                singlePdfBtn.classList.add('single-pdf-btn');
                singlePdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                singlePdfBtn.title = '‡§Ø‡§π ‡§â‡§§‡•ç‡§§‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
                singlePdfBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    generateSinglePdf(entry); // Pass the specific entry to the function
                });
                answerContentDiv.appendChild(singlePdfBtn);


                li.appendChild(answerContentDiv);

                const timestampSmall = document.createElement('small');
                timestampSmall.innerHTML = entry.timestamp;
                li.appendChild(timestampSmall);

                historyList.appendChild(li);
            });
        };

        // Enhanced loading animation
        const showLoading = () => {
            outputTextContent.innerHTML = '<div class="loading"></div> <span style="margin-left: 10px;">‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§∞‡•Å‡§ï‡•á " YADAV Sir " ‡§Ü‡§™‡§ï‡•á question ‡§ï‡§æ answer ‡§ú‡§∞‡•Ç‡§∞ ‡§¶‡•á‡§ó‡§æ ,  Wait for a while...</span>';
            // Also update placeholder if needed
            if (outputPlaceholder) {
                outputPlaceholder.style.display = 'none';
            }
        };

        // Function to prepare input for a new query type
        const prepareNewQuery = (type) => {
            questionInput.value = '';
            uploadedImageData = null;
            imagePreview.style.display = 'none';
            outputTextContent.innerHTML = '<div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>';
            speakerBtn.style.display = 'none'; // Hide speaker button on clear
            mainMenuModal.classList.remove('show');
            stopSpeaking();
            
            if (type === 'gk') {
                questionInput.placeholder = 'üí° ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á, "‡§ó‡•Å‡§∞‡•Å‡§§‡•ç‡§µ‡§æ‡§ï‡§∞‡•ç‡§∑‡§£ ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§ø‡§∏‡§®‡•á ‡§ï‡•Ä?")';
                outputTextContent.innerHTML = `<div id="outputPlaceholder">‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞! ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§</div>`;
            } else if (type === 'math') {
                questionInput.placeholder = 'üî¢ ‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§™‡•Ç‡§õ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á, "2x + 5 = 11 ‡§π‡§≤ ‡§ï‡§∞‡•á‡§Ç")';
                outputTextContent.innerHTML = `<div id="outputPlaceholder">‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞! ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§</div>`;
            } else {
                questionInput.placeholder = '‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!';
                outputTextContent.innerHTML = '<div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>';
            }
            questionInput.focus();
        };

        // --- Event Listeners ---

        // Camera button
        cameraBtn.addEventListener('click', startCamera);

        // Camera controls
        captureBtn.addEventListener('click', capturePhoto);
        closeCameraBtn.addEventListener('click', stopCamera);
        switchCameraBtn.addEventListener('click', switchCamera);
        flashBtn.addEventListener('click', toggleFlash);

        // Close camera modal when clicking outside
        cameraModal.addEventListener('click', (e) => {
            if (e.target === cameraModal) {
                stopCamera();
            }
        });

        // Microphone button
        micBtn.addEventListener('click', () => {
            if (!recognition) return;

            micBtn.disabled = true;
            micBtn.style.background = '#ffd700';
            micBtn.querySelector('i').classList.add('fa-beat');
            stopSpeaking();
            speakerBtn.style.display = 'none';

            recognition.start();
            outputTextContent.innerHTML = 'üîä ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§';
            questionInput.placeholder = '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à...';
        });

        if (recognition) {
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                questionInput.value = speechResult;
                outputTextContent.innerHTML = '<div id="outputPlaceholder">üîä ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≠‡•á‡§ú‡•á‡§Ç ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>';
            };

            recognition.onend = () => {
                micBtn.disabled = false;
                micBtn.style.background = '';
                micBtn.querySelector('i').classList.remove('fa-beat');
                questionInput.placeholder = '‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!';
            };

            recognition.onerror = (event) => {
                console.error('‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event.error);
                outputTextContent.innerHTML = `üîä ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.error}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                micBtn.disabled = false;
                micBtn.style.background = '';
                micBtn.querySelector('i').classList.remove('fa-beat');
            };
        }

        // Image Input (File Upload)
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    imagePreview.src = reader.result;
                    imagePreview.style.display = 'block';
                    uploadedImageData = {
                        mimeType: file.type,
                        data: reader.result.split(',')[1]
                    };
                    questionInput.placeholder = `üñºÔ∏è ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§ó‡§à! ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)`;
                    outputTextContent.innerHTML = `<div id="outputPlaceholder">üñºÔ∏è ‡§õ‡§µ‡§ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•Å‡§à! ‡§Ö‡§¨ ‡§Ü‡§™ ‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</div>`;
                    stopSpeaking();
                    speakerBtn.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
                uploadedImageData = null;
                questionInput.placeholder = `‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®, ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!`;
                outputTextContent.innerHTML = '<div id="outputPlaceholder">‡§Ü‡§™‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§ ‚ú®</div>';
                stopSpeaking();
                speakerBtn.style.display = 'none';
            }
        });

        // Clear Input Button
        clearInputBtn.addEventListener('click', () => {
            prepareNewQuery('general');
            imageInput.value = '';
            stopSpeaking();
            speakerBtn.style.display = 'none';
        });

        // Send/Get Answer Button
        sendBtn.addEventListener('click', async () => {
            const textQuestion = questionInput.value.trim();

            if (!textQuestion && !uploadedImageData) {
                outputTextContent.innerHTML = '<div id="outputPlaceholder">üí° ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç!</div>';
                return;
            }

            showLoading();
            setInteractionState(true);
            stopSpeaking();
            speakerBtn.style.display = 'none';

            try {
                const answer = await performAIQuery(textQuestion, uploadedImageData);
                outputTextContent.innerHTML = answer.replace(/\n/g, '<br>');

                const isNotError = !answer.startsWith("API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:") && !answer.startsWith("‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:") && !answer.startsWith("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:") && !answer.startsWith("‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß:");

                if (isNotError) {
                    addToHistory(textQuestion, answer, !!uploadedImageData);

                    const lowerCasePrompt = textQuestion.toLowerCase();
                    const isGKQuestion = lowerCasePrompt.match(/(who is)|(what is)|(tell me about)|(define)|(fact)|(describe)|(explain)|(history of)|(when did)|(where is)|(what are)|(list)|(quiz)|(gk)|(general knowledge)|(‡§¨‡§§‡§æ‡§ì)|(‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à)|(‡§ï‡•å‡§® ‡§π‡•à)|(‡§ï‡§¨)|(‡§ï‡§π‡§æ‡§Ç)/i);

                    if (isGKQuestion && 'speechSynthesis' in window && hindiVoice) {
                        speakerBtn.style.display = 'flex';
                        speakerBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        speakerBtn.classList.remove('playing');
                        console.log("GK/‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§â‡§§‡•ç‡§§‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•ç‡§™‡•Ä‡§ï‡§∞ ‡§¨‡§ü‡§® ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
                    } else {
                        speakerBtn.style.display = 'none';
                    }
                } else {
                    speakerBtn.style.display = 'none';
                }

            } finally {
                setInteractionState(false);
            }
        });

        // --- Main Speaker Button Click Handler ---
        speakerBtn.addEventListener('click', () => {
            const answerText = outputTextContent.innerText.trim(); 
            if (isSpeaking) {
                stopSpeaking();
            } else {
                if (answerText && answerText !== outputPlaceholder.innerText.trim()) { 
                    speakAnswer(answerText, speakerBtn);
                } else {
                    console.warn('‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§∏‡•á ‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
                    alert('‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§∏‡•Å‡§®‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§');
                }
            }
        });


        // --- Share Result Button Logic ---
        shareResultBtn.addEventListener('click', async () => {
            const currentQuestion = questionInput.value.trim();
            const currentAnswer = outputTextContent.querySelector('#outputPlaceholder') ? '' : outputTextContent.innerText.trim();

            if (!currentQuestion && !uploadedImageData && currentAnswer === '') {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç ‡§î‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç, ‡§´‡§ø‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§');
                return;
            }

            const shareText = `${APP_NAME}\n\n` +
                               `‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${currentQuestion || (uploadedImageData ? '‡§õ‡§µ‡§ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç')}\n\n` +
                               `‡§â‡§§‡•ç‡§§‡§∞: ${currentAnswer || '‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç'}\n\n` +
                               `‡§á‡§∏ AI ‡§ê‡§™ ‡§∏‡•á ‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ì‡§Ç ‡§ï‡§æ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§™‡§æ‡§è‡§Ç: ${APP_URL}`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `${APP_NAME} ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ`,
                        text: shareText,
                        url: APP_URL
                    });
                    console.log('‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡•Ä ‡§ó‡§à!');
                } catch (error) {
                    console.error('‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                    if (error.name !== 'AbortError') {
                        alert(`‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•: ${error.message}`);
                    }
                }
            } else {
                alert('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Ä‡§ß‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π‡§æ‡§Å ‡§™‡§æ‡§† ‡§π‡•à:\n\n' + shareText);
            }
        });


        // --- Main Menu Logic ---
        menuBtn.addEventListener('click', () => {
            mainMenuModal.classList.add('show');
            stopSpeaking();
        });

        closeMainMenuBtn.addEventListener('click', () => {
            mainMenuModal.classList.remove('show');
        });

        mainMenuModal.addEventListener('click', (e) => {
            if (e.target === mainMenuModal) {
                mainMenuModal.classList.remove('show');
            }
        });

        // Link History from Main Menu button
        openHistoryBtn.addEventListener('click', () => {
            mainMenuModal.classList.remove('show');
            stopSpeaking();
            displayHistory(); // Important: call displayHistory to refresh the list with speaker buttons
            historyModal.classList.add('show');
        });

        // Download App (PWA) button
        downloadAppBtn.addEventListener('click', () => {
            alert("‡§Ø‡§π ‡§è‡§ï ‡§µ‡•á‡§¨ ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§π‡•à! ‡§á‡§∏‡•á '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°' ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ö‡§™‡§®‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•á '‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç' ‡§Ø‡§æ '‡§ê‡§™ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç' ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§");
            mainMenuModal.classList.remove('show');
        });

        // New Share App Button Logic
        shareAppBtn.addEventListener('click', async () => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: APP_NAME,
                        text: '‡§ó‡§£‡§ø‡§§ ‡§î‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•á ‡§ù‡§ü‡§™‡§ü ‡§ú‡§µ‡§æ‡§¨ ‡§™‡§æ‡§è‡§Ç ‡§á‡§∏ AI ‡§ê‡§™ ‡§∏‡•á!',
                        url: APP_URL
                    });
                    console.log('‡§ê‡§™ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
                } catch (error) {
                    console.error('‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                    if (error.name !== 'AbortError') {
                        alert(`‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•: ${error.message}`);
                    }
                }
            } else {
                alert('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Ä‡§ß‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§ê‡§™ ‡§ï‡§æ URL ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à:\n\n' + APP_URL + '\n\n‡§á‡§∏‡•á ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§');
            }
            mainMenuModal.classList.remove('show');
        });

        // New GK Question button
        newGkQuestionBtn.addEventListener('click', () => prepareNewQuery('gk'));

        // New Math Problem button
        newMathProblemBtn.addEventListener('click', () => prepareNewQuery('math'));

        // --- History Modal Logic ---
        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.remove('show');
            stopSpeaking();
        });

        // Close history modal when clicking outside
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.remove('show');
                stopSpeaking();
            }
        });

        // --- PDF Download All History Logic ---
        downloadHistoryPdfBtn.addEventListener('click', async () => {
            if (history.length === 0) {
                alert('‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
                return;
            }

            stopSpeaking(); // Stop any ongoing speech before PDF generation

            const tempDiv = document.createElement('div');
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.style.padding = '20px';
            tempDiv.style.color = '#333';
            tempDiv.style.lineHeight = '1.6';

            let historyContentHtml = `<h1 style="color: #667eea; text-align: center; margin-bottom: 20px;">${APP_NAME} - ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h1>`;
            history.forEach((entry, index) => {
                const questionDisplay = entry.question || (entry.imageUsed ? '‡§õ‡§µ‡§ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç');
                historyContentHtml += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                        <h3 style="color: #764ba2; margin-top: 0;">‡§™‡•ç‡§∞‡§∂‡•ç‡§® ${history.length - index}:</h3>
                        <p>${questionDisplay}</p>
                        <h3 style="color: #764ba2;">‡§â‡§§‡•ç‡§§‡§∞:</h3>
                        <p>${entry.answer.replace(/\n/g, '<br>')}</p>
                        <small style="display: block; text-align: right; color: #777;">‡§§‡§ø‡§•‡§ø: ${entry.timestamp}</small>
                    </div>
                `;
            });

            // ‡§Ü‡§™‡§ï‡§æ ‡§´‡•Å‡§ü‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à
            historyContentHtml += `
             <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.8em; color: #999;">
                <p style="margin: 5px 0;">¬©YADAV_Sir_AI_Solver_All_History</p>
                <p style="margin: 5px 0;"><a href="${APP_URL}" target="_blank" style="color: #667eea; text-decoration: none;">‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ 1 ‡§Æ‡§ø‡§®‡§ü ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§Ø‡•á Ai ‡§∏‡•á -‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</a></p>
            </div>
             `;
            tempDiv.innerHTML = historyContentHtml;


            const opt = {
                margin: 0.5,
                filename: 'YADAV_Sir_AI_Solver_All_History.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Show a temporary loading message in the modal
            const historyModalContent = historyModal.querySelector('.modal-content');
            const originalContent = historyModalContent.innerHTML;
            historyModalContent.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div class="loading" style="width: 40px; height: 40px; border-width: 5px; margin: 0 auto 20px;"></div>
                    <p style="color: #667eea; font-size: 1.2em;">PDF ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                </div>
            `;
            downloadHistoryPdfBtn.disabled = true; // Disable button during process
            document.querySelectorAll('.single-pdf-btn').forEach(btn => btn.disabled = true); // Disable individual PDF buttons

            try {
                await html2pdf().from(tempDiv).set(opt).save();
                console.log('‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü!');
            } catch (error) {
                console.error('PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤ ‡§π‡•Å‡§Ü:', error);
                alert('PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
            } finally {
                // Restore original content after PDF generation
                historyModalContent.innerHTML = originalContent;
                displayHistory(); // Re-render history list to re-attach event listeners and re-enable buttons
            }
        });


        // Initial setup: load history and display it
        loadHistory();
        displayHistory(); // Call once on load to show initial history
    });
</script>
</body>
</html>